{% extends "base.html" %} {% load tz %} {% load chat_filters %} {% block content %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Arial", sans-serif;
  }
  .chat-container {
    background-color: black;
    color: white;
    height: calc(100vh - 60px);
    display: flex;
    overflow: hidden;
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
  }

  /* Chat List Panel */
  .chat-list-panel {
    width: 30%;
    height: 100%;
    background-color: #1a1a1a;
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    margin: 10px;
  }

  .chat-list-title {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #333;
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
  }

  .chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
  }

  .chat-item:hover {
    background-color: #2a2a2a;
  }

  .chat-item.active {
    background-color: #333;
  }

  .chat-item-pfp {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444; /* Fallback background for initials */
    font-size: 20px;
    font-weight: bold;
    color: white;
    margin-right: 15px;
    flex-shrink: 0;
  }

  .pfp-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .pfp-initials {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  .chat-item-details {
    flex: 1;
    overflow: hidden;
    margin-right: 40px; /* Add space for the unread indicator */
  }

  .chat-item-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .chat-item-preview {
    color: #aaa;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chat-item-time {
    position: absolute;
    bottom: 12px;
    right: 12px;
    font-size: 12px;
    color: #666;
  }

  /* Chat Area */
  .chat-area {
    flex: 1;
    background-color: #1a1a1a;
    border-radius: 15px;
    margin: 10px;
    margin-left: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Add this to prevent content overflow */
  }

  .chat-header {
    padding: 20px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    background-color: #1a1a1a;
  }

  .chat-header-pfp {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    margin-right: 15px;
  }

  .chat-header-info {
    flex: 1;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
  }

  .chat-header-info:hover {
    background-color: #2a2a2a;
  }

  .chat-header-name {
    font-size: 18px;
    font-weight: bold;
  }

  .chat-header-subtitle {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }

  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background-color: #1a1a1a;
    align-items: stretch;
    min-height: 0; /* Add this to ensure proper flex behavior */
    height: 100%; /* Add this to ensure container takes full height */
  }

  .messages-container:has(.start-message) {
    justify-content: center;
    align-items: center;
  }

  .start-message {
    text-align: center;
    color: #aaa;
    font-size: 24px;
    max-width: 80%;
    margin: 0 auto;
    margin-bottom: 20px;
    animation: fadeIn 0.8s ease-in-out;
  }

  .message {
    max-width: 70%;
    padding: 12px 15px;
    border-radius: 15px;
    margin-bottom: 15px;
    word-wrap: break-word;
    position: relative;
    width: fit-content;
    cursor: context-menu;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .message-pfp {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    flex-shrink: 0;
  }

  .message-pfp img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .message-pfp .pfp-initials {
    font-size: 14px;
    font-weight: bold;
    color: white;
  }

  .message-content {
    flex: 1;
  }

  .message-attachment {
    margin-top: 8px;
    padding: 8px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    max-width: 300px;
  }

  .attachment-image {
    max-width: 100%;
    max-height: 200px;
    border-radius: 4px;
  }

  .file-icon {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }

  .file-info {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .file-name {
    font-size: 14px;
    word-break: break-word;
    text-align: center;
    max-width: 280px;
    margin-bottom: 5px;
  }

  .file-link {
    color: #3498db;
    text-decoration: none;
    font-size: 12px;
    padding: 3px 10px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .file-link:hover {
    background-color: rgba(0, 0, 0, 0.3);
    text-decoration: underline;
  }

  .message-attachment .file-info {
    background: rgba(0, 0, 0, 0.5);
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .message-attachment .file-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #444;
    border-radius: 4px;
  }

  .message-attachment .file-name {
    color: white;
    font-size: 14px;
    word-break: break-all;
  }

  .message-attachment .file-size {
    color: #aaa;
    font-size: 12px;
    white-space: nowrap;
  }

  .attachment-preview {
    display: none;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 8px;
    position: relative;
  }

  .attachment-preview.show {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .attachment-preview img {
    max-width: 100px;
    max-height: 100px;
    border-radius: 4px;
  }

  .attachment-preview .file-info {
    flex: 1;
  }

  .attachment-preview .remove-attachment {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }

  .attachment-preview .remove-attachment:hover {
    background: rgba(255, 0, 0, 0.7);
  }

  #fileInput {
    display: none;
  }

  .message.deleted {
    font-style: italic;
    color: #666;
  }

  .message-sent {
    background-color: #2a2a2a;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
    flex-direction: row-reverse;
  }

  .message-received {
    background-color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 5px;
  }

  .message-time {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
    text-align: right;
    display: inline-flex;
    align-items: center;
  }

  .message-read-status {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    margin-left: 4px;
  }

  .read-receipt {
    display: inline-flex;
    align-items: center;
  }

  .read-receipt-icon {
    font-size: 14px;
    color: #888;
  }

  .read-receipt.read .read-receipt-icon {
    color: #2196f3;
  }

  /* Remove unnecessary text elements */
  .read-receipt-text {
    display: none;
  }

  .input-area {
    padding: 15px;
    border-top: 1px solid #333;
    display: flex;
    background-color: #1a1a1a;
    position: relative; /* Add this to ensure proper stacking */
    z-index: 1; /* Add this to ensure proper stacking */
  }

  .message-input {
    flex: 1;
    background-color: #2a2a2a;
    border: none;
    border-radius: 20px;
    padding: 12px 15px;
    color: white;
    outline: none;
    margin-right: 10px;
  }

  .input-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .attach-button,
  .send-button {
    background-color: #333;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    position: relative;
  }

  .attach-button:hover,
  .send-button:hover {
    background-color: #444;
  }

  .attach-button svg {
    width: 20px;
    height: 20px;
  }

  /* Add tooltip styles */
  .tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 5px 10px;
    background-color: #333;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    margin-bottom: 5px;
    pointer-events: none;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
  }

  .attach-button:hover .tooltip,
  .send-button:hover .tooltip {
    opacity: 1;
    visibility: visible;
  }

  .add-contact-button {
    display: block;
    margin: 0 auto;
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(135deg, #333 0%, #444 100%);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    width: auto;
    min-width: 120px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    animation: slideUp 0.5s ease-out 0.3s both;
  }

  .add-contact-button:hover {
    background: linear-gradient(135deg, #444 0%, #555 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  @keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  @keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #1a1a1a;
  }

  ::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #444;
  }

  .dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .dialog-box {
    background-color: #1a1a1a;
    padding: 25px;
    border-radius: 15px;
    width: 350px;
    text-align: center;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
  }

  .dialog-title {
    font-size: 20px;
    margin-bottom: 15px;
    color: white;
  }

  .input-field {
    width: 100%;
    padding: 12px 15px;
    border-radius: 20px;
    border: none;
    background-color: #2a2a2a;
    color: white;
    outline: none;
    font-size: 14px;
  }

  #search-result {
    width: 100%;
    margin-top: 10px;
  }

  .search-result-item {
    width: 100%;
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-top: 10px;
    border-radius: 10px;
    background-color: #2a2a2a;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .search-result-item:hover {
    background-color: #333;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .add-friend-btn {
    background: #333;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 14px;
  }

  .add-friend-btn:hover {
    background: #444;
  }

  .dialog-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 15px;
  }

  .dialog-button {
    padding: 10px 20px;
    background-color: #333;
    border: none;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
    flex: 1;
    font-size: 14px;
  }

  .dialog-button:hover {
    background-color: #444;
  }

  /* Add this to your existing styles */
  .context-menu {
    position: fixed;
    background: #2a2a2a;
    border-radius: 8px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 9999;
  }

  .context-menu-header {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    border-bottom: 1px solid #444;
    margin-bottom: 4px;
  }

  .context-menu-pfp {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    margin-right: 10px;
  }

  .context-menu-pfp img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .context-menu-pfp .pfp-initials {
    font-size: 14px;
    font-weight: bold;
    color: white;
  }

  .context-menu-name {
    color: white;
    font-weight: bold;
  }

  .context-menu-item {
    padding: 8px 15px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s;
  }

  .context-menu-item:hover {
    background-color: #333;
  }

  .context-menu-item.danger {
    color: #ff6b6b;
  }

  .context-menu-divider {
    height: 1px;
    background-color: #444;
    margin: 4px 0;
  }

  .unread-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #4CAF50;
    display: none;
  }

  .chat-item.has-unread .unread-indicator {
    display: block;
  }

  .unread-count {
    display: none;
  }

  /* Add this after your existing styles */
  .notifications-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .notifications-content {
    background: #1e1e1e;
    padding: 30px;
    border-radius: 15px;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }

  .notifications-header {
    margin-bottom: 20px;
    color: white;
    font-size: 24px;
    text-align: center;
  }

  .notification-item {
    background: #2a2a2a;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s ease;
  }

  .notification-item:hover {
    transform: translateY(-2px);
  }

  .notification-item.warning {
    border-left: 4px solid #ffa500;
  }

  .notification-item.info {
    border-left: 4px solid #3498db;
  }

  /* Special styling for broadcast notifications */
  .notification-item.broadcast {
    border: 1px solid #ffd700;
    background: linear-gradient(to right, #2a2a2a, #1a1a1a);
  }

  #notificationIndicator {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 8px;
    height: 8px;
    background-color: #ffd700;
    border-radius: 50%;
    display: none;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.2);
      opacity: 0.8;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .notification-type {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .notification-message {
    margin: 10px 0;
  }

  .notification-admin-notes {
    font-size: 0.9em;
    color: #888;
    margin-top: 5px;
  }

  .notification-time {
    font-size: 0.8em;
    color: #666;
    margin-top: 5px;
  }

  .notifications-close {
    position: absolute;
    top: 10px;
    right: 15px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
  }

  /* Add these new styles */
  .user-actions-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1a1a1a;
    border-radius: 15px;
    padding: 20px;
    z-index: 1001;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .user-actions-content {
    position: relative;
  }

  .user-actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #333;
    text-align: center;
    position: relative;
  }

  .user-actions-header h2 {
    margin: 0;
    color: white;
    font-size: 20px;
    width: 100%;
    text-align: center;
  }

  .close-modal {
    color: #666;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    position: absolute;
    right: 0;
  }

  .close-modal:hover {
    color: white;
  }

  .user-info-section {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }

  .user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-initials {
    color: white;
    font-size: 24px;
    font-weight: bold;
  }

  .user-details h3 {
    margin: 0;
    color: white;
    font-size: 18px;
  }

  .user-username {
    color: #666;
    font-size: 14px;
    margin-top: 4px;
  }

  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .action-button {
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
    width: 100%;
  }

  .action-button.delete {
    background-color: #2a2a2a;
  }

  .action-button.delete:hover {
    background-color: #dc3545;
  }

  .action-button.block {
    background-color: #2a2a2a;
  }

  .action-button.block:hover {
    background-color: #6c757d;
  }

  .modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }

  /* Add these new styles before the closing style tag */
  .delete-confirmation-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1a1a1a;
    border-radius: 15px;
    padding: 25px;
    z-index: 1002;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .delete-confirmation-content {
    text-align: center;
  }

  .delete-confirmation-title {
    color: #ff6b6b;
    font-size: 24px;
    margin-bottom: 15px;
  }

  .delete-confirmation-message {
    color: #fff;
    margin-bottom: 25px;
    line-height: 1.5;
  }

  .delete-confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .delete-confirmation-button {
    padding: 10px 25px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .delete-confirmation-button.cancel {
    background: #333;
    color: white;
  }

  .delete-confirmation-button.cancel:hover {
    background: #444;
  }

  .delete-confirmation-button.confirm {
    background: #ff6b6b;
    color: white;
  }

  .delete-confirmation-button.confirm:hover {
    background: #ff5252;
  }

  .toast-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    z-index: 10000;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .toast-message.show {
    opacity: 1;
  }

  .toast-message.success {
    background: #4CAF50;
  }

  .toast-message.error {
    background: #ff6b6b;
  }

  /* Block User Modal Styles */
  .block-confirmation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1003;
    justify-content: center;
    align-items: center;
  }

  .block-confirmation-content {
    background-color: #1a1a1a;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .block-confirmation-content h3 {
    margin: 0 0 1rem 0;
    color: #ff6b6b;
    font-size: 1.5rem;
    text-align: center;
  }

  .block-confirmation-content p {
    margin: 0 0 1.5rem 0;
    color: #fff;
    line-height: 1.5;
    text-align: center;
  }

  .block-confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .block-confirmation-buttons button {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 14px;
  }

  .block-confirmation-buttons button.cancel {
    background-color: #333;
    color: white;
  }

  .block-confirmation-buttons button.cancel:hover {
    background-color: #444;
  }

  .block-confirmation-buttons button.confirm {
    background-color: #ff6b6b;
    color: white;
  }

  .block-confirmation-buttons button.confirm:hover {
    background-color: #ff5252;
  }

  /* Add this CSS code */
  .file-name-display {
    position: absolute;
    right: 100px;
    top: 50%;
    transform: translateY(-50%);
    background-color: #444;
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 12px;
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
  }

  .file-name {
    margin-right: 5px;
    color: white;
  }

  .remove-file {
    background: none;
    border: none;
    color: #aaa;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    padding: 0 2px;
  }

  .remove-file:hover {
    color: white;
  }

  .input-container {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
  }

  /* Fullscreen image viewer styles */
  .fullscreen-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    opacity: 0;
    transition: background-color 0.3s ease, backdrop-filter 0.3s ease, opacity 0.3s ease;
  }

  .fullscreen-modal.visible {
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    opacity: 1;
  }

  .fullscreen-modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
  }

  #fullscreen-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .fullscreen-modal.visible #fullscreen-image {
    opacity: 1;
    transform: scale(1);
  }

  .close-modal {
    position: absolute;
    top: 15px;
    right: 25px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
    transition: color 0.2s;
  }

  .close-modal:hover {
    color: #bbb;
  }

  .download-button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s, opacity 0.3s ease, transform 0.3s ease;
    opacity: 0;
    transform: translateY(10px);
  }

  .fullscreen-modal.visible .download-button {
    opacity: 1;
    transform: translateY(0);
  }

  .download-button:hover {
    background-color: #45a049;
  }

  /* Add pointer cursor to image attachments */
  .message-attachment img {
    cursor: pointer;
    transition: transform 0.2s;
  }

  .message-attachment img:hover {
    transform: scale(1.03);
  }
</style>

<div class="chat-container">
  <!-- Add this right after the chat-container div -->
  /* Add pointer cursor to image attachments */
  .message-attachment img {
    cursor: pointer;
  }
</style>

<div class="chat-container">
  <!-- Add this right after the chat-container div -->
  <div id="deleteConfirmationModal" class="delete-confirmation-modal">
    <div class="delete-confirmation-content">
      <div class="delete-confirmation-title">Delete Chat</div>
      <div class="delete-confirmation-message">
        Are you sure you want to delete this chat? All messages will be permanently lost and cannot be recovered.
      </div>
      <div class="delete-confirmation-buttons">
        <button class="delete-confirmation-button cancel" onclick="closeDeleteConfirmation()">Cancel</button>
        <button class="delete-confirmation-button confirm" onclick="confirmDeleteChat()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add this right after the deleteConfirmationModal div -->
  <div id="blockConfirmationModal" class="block-confirmation-modal">
    <div class="block-confirmation-content">
      <h3>Block User</h3>
      <p>Are you sure you want to block this user? You won't be able to receive messages from them, and they won't be notified.</p>
      <div class="block-confirmation-buttons">
        <button class="cancel" onclick="closeBlockConfirmation()">Cancel</button>
        <button class="confirm" onclick="confirmBlockUser()">Block User</button>
      </div>
    </div>
  </div>

  <!-- Add this right after the chat-container div -->
  <div id="message-context-menu" class="context-menu">
    <div class="context-menu-header">
      <div class="context-menu-pfp" id="contextMenuPfp">
        <!-- Profile picture will be set dynamically -->
      </div>
      <div class="context-menu-name" id="contextMenuName">
        <!-- Name will be set dynamically -->
      </div>
    </div>
    <div class="context-menu-item" onclick="copyMessage(this)" data-message-id="">
      Copy Message
    </div>
    <div class="context-menu-item" onclick="deleteMessageForMe(this)" data-message-id="">
      Delete for me
    </div>
    <div class="context-menu-item danger sender-only" onclick="deleteMessageForEveryone(this)" data-message-id="">
      Delete for everyone
    </div>
    <div class="context-menu-item danger" onclick="reportMessage(this)" data-message-id="">
      Report Message
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="hideContextMenu()">
      Close
    </div>
  </div>

  <!-- Chat List Panel (30% width) -->
  <div class="chat-list-panel">
    <div class="chat-list-title">Chats</div>
    <div class="chat-list">
      <!-- Debug information -->
      <div style="display: none;">
        Current user: {{ request.user.username }}
        Number of chats: {{ chats|length }}
      </div>
      
      {% if chats %}
        {% for chat in chats %}
        <!-- Debug information for each chat -->  
        <div style="display: none;">
          Chat ID: {{ chat.id }}
          Sender: {{ chat.sender.username }}
          Recipient: {{ chat.recipient.username }}
        </div>
        <div
          class="chat-item {% if active_chat and chat.id == active_chat.id %} active {% endif %}{% if chat.unread_count > 0 %} has-unread {% endif %}"
          data-chat-url="{% url 'chat_detail' chat.id %}"
          data-chat-id="{{ chat.id }}"
          onclick="loadChat(this, event)">
          <div class="chat-item-pfp">
            {% if chat.sender == request.user %}
              {% if chat.recipient_profile_pic %}
                <img
                  src="{{ chat.recipient_profile_pic }}"
                  alt="Profile Picture"
                  class="pfp-image"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="pfp-initials" style="display: none;">
                  {{ chat.recipient.first_name|slice:":1" }}{{ chat.recipient.last_name|slice:":1" }}
                </div>
              {% else %}
                <div class="pfp-initials">
                  {{ chat.recipient.first_name|slice:":1" }}{{ chat.recipient.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% else %}
              {% if chat.sender_profile_pic %}
                <img
                  src="{{ chat.sender_profile_pic }}"
                  alt="Profile Picture"
                  class="pfp-image"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="pfp-initials" style="display: none;">
                  {{ chat.sender.first_name|slice:":1" }}{{ chat.sender.last_name|slice:":1" }}
                </div>
              {% else %}
                <div class="pfp-initials">
                  {{ chat.sender.first_name|slice:":1" }}{{ chat.sender.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% endif %}
          </div>
          <div class="chat-item-details">
            <div class="chat-item-name"
                 data-first-name="{% if chat.sender == request.user %}{{ chat.recipient.first_name }}{% else %}{{ chat.sender.first_name }}{% endif %}"
                 data-last-name="{% if chat.sender == request.user %}{{ chat.recipient.last_name }}{% else %}{{ chat.sender.last_name }}{% endif %}">
              {% if chat.sender == request.user %}
                {{ chat.recipient.first_name }} {{ chat.recipient.last_name }}
              {% else %}
                {{ chat.sender.first_name }} {{ chat.sender.last_name }}
              {% endif %}
            </div>
            <div class="chat-item-preview">
              {{ chat.last_message|truncatewords:10 }}
            </div>
          </div>
          <div class="chat-item-time">
            {{ chat.updated_at|localtime|date:"g:i A" }}
          </div>
          <div class="unread-indicator"></div>
        </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; color: #666; padding: 20px;">
          No chats yet. Add a friend to start chatting!
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Chat Area (70% width) -->
  <div class="chat-area">
    <div class="chat-header">
      {% if active_chat %}
        <div class="chat-header-info" onclick="openUserActionsModal()">
          <div class="chat-header-name">
            {% if active_chat.sender == request.user %}
              {{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}
            {% else %}
              {{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}
            {% endif %}
          </div>
          <div class="chat-header-subtitle">Click for actions</div>
        </div>
      {% endif %}
    </div>
    <div class="messages-container">
      {% if active_chat %}
        {% if messages %}
          {% for message in messages %}
            <div class="message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %} {% if message.deleted_for_everyone %}deleted{% endif %}"
                 data-message-id="{{ message.id }}"
                 data-sender-id="{{ message.sender.id }}"
                 oncontextmenu="showContextMenu(event, this)"
                 {% if message.deleted_for.all|contains:request.user %}style="display: none;"{% endif %}>
              <div class="message-pfp">
                {% if message.sender.profile_picture %}
                  <img src="{{ message.sender.profile_picture.url }}" alt="Profile Picture">
                {% else %}
                  <div class="pfp-initials">
                    {{ message.sender.first_name|slice:":1" }}{{ message.sender.last_name|slice:":1" }}
                  </div>
                {% endif %}
              </div>
              <div class="message-content">
                {% if message.deleted_for_everyone %}
                  <i>Message deleted</i>
                {% else %}
                  {{ message.content }}
                  {% if message.attachment %}
                    {% if message.attachment_type == 'image' %}
                      <div class="message-attachment">
                        <img src="{{ message.attachment.url }}" alt="{{ message.attachment_name }}" class="attachment-image">
                      </div>
                    {% else %}
                      <div class="message-attachment">
                        <div class="file-icon">
                          {% if message.attachment_type == 'pdf' %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M12 18C12 17.4 11.6 17 11 17C10.4 17 10 17.4 10 18C10 18.6 10.4 19 11 19C11.6 19 12 18.6 12 18Z" fill="white"/>
                              <path d="M12 13C12 12.4 11.6 12 11 12C10.4 12 10 12.4 10 13V16C10 16.6 10.4 17 11 17C11.6 17 12 16.6 12 16V13Z" fill="white"/>
                            </svg>
                          {% elif message.attachment_type == 'doc' %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M16 13H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M16 17H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M10 9H9H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          {% endif %}
                        </div>
                        <div class="file-info">
                          <div class="file-name">{{ message.attachment_name }}</div>
                          <a href="{{ message.attachment.url }}" target="_blank" class="file-link">Download</a>
                        </div>
                      </div>
                    {% endif %}
                  {% endif %}
                {% endif %}
                <div class="message-time">
                  {{ message.sent_at|localtime|date:"g:i A" }}
                  {% if message.sender == request.user and not message.deleted_for_everyone %}
                  <div class="message-read-status" data-message-id="{{ message.id }}">
                    <span class="read-receipt" id="read-receipt-{{ message.id }}">
                      <span class="read-receipt-icon">&#10003;</span>
                    </span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="start-message" id="no-messages-prompt">No messages yet. Start the conversation!</div>
        {% endif %}
      {% else %}
        <!-- Start messaging prompt -->
        <div class="start-message">Add a friend to start messaging!</div>
        <button class="add-contact-button" onclick="openDialog()">Add</button>
      {% endif %}
    </div>
    {% if active_chat %}
    <div class="input-area" style="display: block;">
      <div class="chat-footer">
        <div class="input-container">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            class="message-input"
            onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
          >
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachment(event)">
          <div class="input-buttons">
            <button class="attach-button" onclick="document.getElementById('fileInput').click()">
              <span class="tooltip">Add attachment</span>
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21.44 11.05L12.25 20.24C11.1242 21.3658 9.5972 21.9983 8.005 21.9983C6.4128 21.9983 4.88584 21.3658 3.76 20.24C2.63416 19.1142 2.00171 17.5872 2.00171 15.995C2.00171 14.4028 2.63416 12.8758 3.76 11.75L12.95 2.56C13.7006 1.80944 14.7186 1.38086 15.78 1.38086C16.8414 1.38086 17.8594 1.80944 18.61 2.56C19.3606 3.31056 19.7892 4.32856 19.7892 5.39C19.7892 6.45144 19.3606 7.46944 18.61 8.22L9.42 17.41C9.0348 17.7952 8.52577 18.0095 7.995 18.0095C7.46423 18.0095 6.95519 17.7952 6.57 17.41C6.18481 17.0248 5.97053 16.5158 5.97053 15.985C5.97053 15.4542 6.18481 14.9452 6.57 14.56L15.76 5.37"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button class="send-button" onclick="sendMessage()">
              <span class="tooltip">Send message</span>
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M22 2L11 13"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M22 2L15 22L11 13L2 9L22 2Z"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="attachment-preview" id="attachmentPreview">
      <button class="remove-attachment" onclick="removeAttachment()">&times;</button>
      <div class="file-info">
        <div class="file-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="file-name" id="attachmentName"></div>
        <div class="file-size" id="attachmentSize"></div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Dialog Box -->
  <div class="dialog-overlay" id="dialog" onclick="handleOverlayClick(event)">
    <div class="dialog-box">
      <div class="dialog-title">Add New Contact</div>
      {% csrf_token %}
      <div style="position: relative;">
        <input
          type="text"
          class="input-field"
          id="username"
          placeholder="Enter Username"
          onkeypress="if(event.key === 'Enter') searchUser()"
        />
      </div>
      <div id="search-result"></div>
      <div class="dialog-buttons">
        <button class="dialog-button" onclick="searchUser()">Search</button>
        <button class="dialog-button" onclick="closeDialog()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add this after your existing modals -->
  <div id="notificationsModal" class="notifications-modal">
    <div class="notifications-content">
      <span class="notifications-close" onclick="closeNotificationsModal()">&times;</span>
      <div class="notifications-header">Notifications</div>
      <div id="notificationsContainer">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add user actions modal -->
  <div id="userActionsModal" class="user-actions-modal">
    <div class="user-actions-content">
      <div class="user-actions-header">
        <h2>Chat Actions</h2>
        <span class="close-modal" onclick="closeUserActionsModal()">&times;</span>
      </div>
      <div class="user-info-section">
        <div class="user-avatar">
          {% if active_chat %}
            {% if active_chat.sender == request.user %}
              {% if active_chat.recipient.profile_picture %}
                <img src="{{ active_chat.recipient.profile_picture.url }}" alt="Profile Picture">
              {% else %}
                <div class="avatar-initials">
                  {{ active_chat.recipient.first_name|slice:":1" }}{{ active_chat.recipient.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% else %}
              {% if active_chat.sender.profile_picture %}
                <img src="{{ active_chat.sender.profile_picture.url }}" alt="Profile Picture">
              {% else %}
                <div class="avatar-initials">
                  {{ active_chat.sender.first_name|slice:":1" }}{{ active_chat.sender.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>
        <div class="user-details">
          <h3>
            {% if active_chat %}
              {% if active_chat.sender == request.user %}
                {{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}
              {% else %}
                {{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}
              {% endif %}
            {% endif %}
          </h3>
          <div class="user-username">
            {% if active_chat %}
              {% if active_chat.sender == request.user %}
                @{{ active_chat.recipient.username }}
              {% else %}
                @{{ active_chat.sender.username }}
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="user-actions">
        <button class="action-button delete" onclick="handleDeleteChat()">
          Delete Chat
        </button>
        <button class="action-button block" onclick="handleBlockUser()">
          Block User
        </button>
      </div>
    </div>
  </div>

  <!-- Add this right before the userActionsModal div -->
  <div id="modalBackdrop" class="modal-backdrop"></div>

  <!-- Add this at the end of the body or after your context menu div -->
  <div id="fullscreen-image-viewer" class="fullscreen-modal">
    <div class="fullscreen-modal-content">
      <span class="close-modal" onclick="closeImageViewer()">&times;</span>
      <img id="fullscreen-image" src="" alt="Fullscreen Image">
      <a id="download-image-btn" href="" download class="download-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download
      </a>
    </div>
  </div>

  <script>
    // Set authentication status for use in JavaScript
    const isUserAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
    
    // Single function to handle both navbar and chat "Add" buttons
    function openDialog() {
      document.getElementById("dialog").style.display = "flex";
      // Clear previous search results and input when opening
      document.getElementById("search-result").innerHTML = "";
      document.getElementById("username").value = "";
    }

    function closeDialog() {
      document.getElementById("dialog").style.display = "none";
    }

    function handleOverlayClick(event) {
      // Close dialog only if clicking the overlay itself, not its children
      if (event.target.classList.contains('dialog-overlay')) {
        closeDialog();
      }
    }

    function searchUser() {
      const username = document.getElementById("username").value;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const searchResult = document.getElementById("search-result");
      
      if (!username.trim()) {
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">Please enter a username</div>';
        return;
      }
      
      console.log("Searching for user:", username);
      searchResult.innerHTML = '<div class="search-result-item">Searching...</div>';

      fetch("/search_user/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
        }),
      })
      .then(response => response.json())
      .then((data) => {
        console.log("Search response data:", data);
        if (data.status === "success") {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'search-result-item';
          resultDiv.textContent = `${data.first_name} ${data.last_name}`;
          resultDiv.addEventListener('click', function() {
            console.log('Search result clicked');
            startChat(data.username);
          });
          
          searchResult.innerHTML = '';
          searchResult.appendChild(resultDiv);
        } else {
          searchResult.innerHTML = `<div class="search-result-item" style="color: #ff6b6b;">${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error('Error in searchUser:', error);
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">An error occurred. Please try again.</div>';
      });
    }

    function startChat(username) {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      console.log("Starting chat with:", username);
      console.log("Using CSRF token:", csrfToken);

      fetch("/start_chat/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
        }),
      })
      .then(response => {
        console.log("Start chat response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Start chat response data:", data);
        if (data.status === 'success') {
          // Close the dialog
          closeDialog();
          
          // Create new chat item if it doesn't exist
          if (!document.querySelector(`[data-chat-url="/chats/${data.chat_id}/"]`)) {
            console.log("Creating new chat item in the list");
            const chatList = document.querySelector('.chat-list');
            const noChatsMessage = chatList.querySelector('div[style*="text-align: center"]');
            if (noChatsMessage) {
              noChatsMessage.remove();
            }

            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-url', `/chats/${data.chat_id}/`);
            chatItem.onclick = () => window.location.href = `/chats/${data.chat_id}/`;

            const initials = `${data.recipient.first_name[0]}${data.recipient.last_name[0]}`;
            
            chatItem.innerHTML = `
              <div class="chat-item-pfp">
                ${data.recipient.profile_picture 
                  ? `<img src="${data.recipient.profile_picture}" alt="Profile Picture" class="pfp-image" style="display: block;">` 
                  : `<div class="pfp-initials">${initials}</div>`}
              </div>
              <div class="chat-item-details">
                <div class="chat-item-name"
                     data-first-name="${data.recipient.first_name}"
                     data-last-name="${data.recipient.last_name}">
                  ${data.recipient.first_name} ${data.recipient.last_name}
                </div>
                <div class="chat-item-preview">
                  No messages yet
                </div>
              </div>
              <div style="font-size: 12px; color: #666; text-align: right">
                Just now
              </div>
            `;

            // Add the new chat item at the top of the list
            chatList.insertBefore(chatItem, chatList.firstChild);
            console.log("New chat item added to the list");
          } else {
            console.log("Chat item already exists in the list");
          }
          
          // Redirect to the chat
          console.log("Redirecting to chat:", `/chats/${data.chat_id}/`);
          window.location.href = `/chats/${data.chat_id}/`;
        } else {
          // Show error message
          console.error("Error starting chat:", data.message);
          document.getElementById("search-result").innerHTML = 
            `<div class="search-result-item" style="color: #ff6b6b;">${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error('Error in startChat:', error);
        document.getElementById("search-result").innerHTML = 
          '<div class="search-result-item" style="color: #ff6b6b;">An error occurred. Please try again.</div>';
      });
    }

    // Handle profile pictures and initials
    document.querySelectorAll(".chat-item").forEach((chatItem) => {
      const pfpImage = chatItem.querySelector(".pfp-image");
      const pfpInitials = chatItem.querySelector(".pfp-initials");

      if (pfpImage) {
        // Set initial display to block
        pfpImage.style.display = "block";
        
        // Add error handler for the image
        pfpImage.onerror = function() {
          console.log("Profile picture failed to load, showing initials");
          this.style.display = "none";
          if (pfpInitials) {
            pfpInitials.style.display = "flex";
          }
        };
        
        // Add load handler for the image
        pfpImage.onload = function() {
          console.log("Profile picture loaded successfully");
          this.style.display = "block";
          if (pfpInitials) {
            pfpInitials.style.display = "none";
          }
        };
      }
    });

    // Scroll messages container to bottom when loading chat
    document.addEventListener("DOMContentLoaded", function() {
      const messagesContainer = document.querySelector(".messages-container");
      if (messagesContainer) {
        // Force a reflow to ensure scrollHeight is calculated correctly
        setTimeout(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
      }

      // Initialize input area if there's an active chat
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      if (activeChatId && inputArea) {
        inputArea.style.display = 'block';
      }
    });

    // Also scroll to bottom when messages are loaded or when switching chats
    function scrollToBottom() {
      const messagesContainer = document.querySelector(".messages-container");
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // Call scrollToBottom when the page loads
    window.onload = function() {
      scrollToBottom();
      
      // Ensure input area is visible if there's an active chat
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      if (activeChatId && inputArea) {
        inputArea.style.display = 'block';
      }
    };

    // Ensure images are loaded before scrolling
    document.querySelectorAll('.messages-container img').forEach(img => {
      img.onload = scrollToBottom;
    });

    // Add these new functions to your existing script
    let selectedMessageElement = null;

    function showContextMenu(event, messageElement) {
      // Hide any existing context menu first
      hideContextMenu();
      
      event.preventDefault(); // Prevent default context menu
      event.stopPropagation(); // Stop event from bubbling up
      
      const contextMenu = document.getElementById('message-context-menu');
      if (!contextMenu) {
        return;
      }
      
      const messageId = messageElement.dataset.messageId;
      const senderId = messageElement.dataset.senderId;
      const currentUserId = "{{ request.user.id }}";
      
      if (!messageId) {
        return;
      }

      // Get the profile picture and name from the message
      const messagePfp = messageElement.querySelector('.message-pfp');
      const contextMenuPfp = document.getElementById('contextMenuPfp');
      const contextMenuName = document.getElementById('contextMenuName');

      // Copy the profile picture content
      if (messagePfp) {
        contextMenuPfp.innerHTML = messagePfp.innerHTML;
      }

      // Set the sender's name
      {% if active_chat %}
      if (senderId === currentUserId) {
        contextMenuName.textContent = "{{ request.user.first_name }} {{ request.user.last_name }}";
      } else {
        contextMenuName.textContent = "{% if active_chat.sender == request.user %}{{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}{% else %}{{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}{% endif %}";
      }
      {% endif %}
      
      // Show/hide "Delete for everyone" option based on whether user is the sender
      const deleteForEveryoneOption = contextMenu.querySelector('.sender-only');
      if (deleteForEveryoneOption) {
        deleteForEveryoneOption.style.display = senderId === currentUserId ? 'block' : 'none';
      }
      
      // Update the message ID and content in all context menu items
      contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
        item.dataset.messageId = messageId;
        item.dataset.messageContent = messageElement.querySelector('.message-content').textContent.trim();
      });
      
      // Position the context menu at the mouse position
      contextMenu.style.display = 'block';
      
      // Calculate position relative to viewport
      const x = event.clientX;
      const y = event.clientY;
      
      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Get menu dimensions
      const menuWidth = contextMenu.offsetWidth;
      const menuHeight = contextMenu.offsetHeight;
      
      // Check if menu goes outside viewport
      const rightEdgeExceeded = x + menuWidth > viewportWidth;
      const bottomEdgeExceeded = y + menuHeight > viewportHeight;
      
      // Position menu
      contextMenu.style.left = rightEdgeExceeded ? `${x - menuWidth}px` : `${x}px`;
      contextMenu.style.top = bottomEdgeExceeded ? `${y - menuHeight}px` : `${y}px`;
    }

    function copyMessage(menuItem) {
      const messageContent = menuItem.dataset.messageContent;
      if (messageContent) {
        navigator.clipboard.writeText(messageContent)
          .then(() => {
            // Show a brief notification that the message was copied
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#333';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '10000';
            notification.textContent = 'Message copied!';
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 2000);
          })
          .catch(err => console.error('Failed to copy message:', err));
      }
      hideContextMenu();
    }

    function hideContextMenu() {
      const contextMenu = document.getElementById('message-context-menu');
      if (contextMenu) {
        contextMenu.style.display = 'none';
      }
    }

    // Close context menu when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('#message-context-menu')) {
        hideContextMenu();
      }
    });

    // Close context menu when scrolling
    const messagesContainer = document.querySelector('.messages-container');
    if (messagesContainer) {
      messagesContainer.addEventListener('scroll', hideContextMenu);
    }

    // Close context menu when pressing Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        hideContextMenu();
      }
    });

    // Close context menu when window is resized
    window.addEventListener('resize', hideContextMenu);

    // Prevent context menu from appearing on right-click outside messages
    document.addEventListener('contextmenu', function(event) {
      if (!event.target.closest('.message')) {
        event.preventDefault();
        hideContextMenu();
      }
    });

    function deleteMessageForMe(menuItem) {
      const messageId = menuItem.dataset.messageId;
      if (!messageId) return;

      fetch('/delete_message_for_me/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message_id: messageId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Refresh the page to show changes
          window.location.reload();
        } else {
          alert('Failed to delete message. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete message. Please try again.');
      });
      
      hideContextMenu();
    }

    function deleteMessageForEveryone(menuItem) {
      const messageId = menuItem.dataset.messageId;
      if (!messageId) return;

      fetch('/delete_message_for_everyone/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message_id: messageId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Refresh the page to show changes
          window.location.reload();
        } else {
          alert('Failed to delete message. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete message. Please try again.');
      });
      
      hideContextMenu();
    }

    function reportMessage(menuItem) {
      const messageId = menuItem.dataset.messageId;
      if (!messageId) return;

      fetch('/report_message/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message_id: messageId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Show success notification
          const notification = document.createElement('div');
          notification.style.position = 'fixed';
          notification.style.bottom = '20px';
          notification.style.left = '50%';
          notification.style.transform = 'translateX(-50%)';
          notification.style.backgroundColor = '#4CAF50';
          notification.style.color = 'white';
          notification.style.padding = '10px 20px';
          notification.style.borderRadius = '5px';
          notification.style.zIndex = '10000';
          notification.textContent = 'Message reported successfully';
          document.body.appendChild(notification);
          
          setTimeout(() => notification.remove(), 3000);
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to report message. Please try again.');
      });
      
      hideContextMenu();
    }

    // Add these functions to your existing script
    function checkNotifications() {
      console.log('Checking notifications...');
      fetch('/check_notifications/', {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => {
        console.log('Notification check response:', response);
        return response.json();
      })
      .then(data => {
        console.log('Notification data:', data);
        const hasUnread = data.notifications && data.notifications.length > 0;
        const indicator = document.getElementById('notificationIndicator');
        if (indicator) {
          indicator.style.display = hasUnread ? 'block' : 'none';
        }
      })
      .catch(error => {
        console.error('Error checking notifications:', error);
      });
    }

    function loadNotifications() {
      console.log('Loading notifications...');
      const container = document.getElementById('notificationsContainer');
      
      if (!container) {
        console.error('Notifications container not found');
        return;
      }
      
      container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';

      fetch('/check_notifications/', {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('Loaded notification data:', data);
        if (!data.notifications || data.notifications.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #888;">No notifications</div>';
          return;
        }

        container.innerHTML = data.notifications.map(notification => `
          <div class="notification-item ${notification.type} ${notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 'broadcast' : ''}">
            <div class="notification-type" style="color: ${notification.type === 'warning' ? '#ffa500' : '#3498db'}">
              ${notification.type === 'warning' ? 'WARNING' : 
                notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 'ADMIN BROADCAST' : 'INFORMATION'}
            </div>
            <div class="notification-message" style="
              ${notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 
                'font-size: 1.1em; color: #fff; margin: 15px 0;' : ''}">
              ${notification.message}
            </div>
            ${notification.admin_notes ? `
              <div class="notification-admin-notes" style="
                color: ${notification.admin_notes.includes('Broadcast') ? '#ffd700' : '#888'};
                font-style: ${notification.admin_notes.includes('Broadcast') ? 'italic' : 'normal'};
              ">
                ${notification.admin_notes.includes('Broadcast') ? 
                  notification.admin_notes : `Admin notes: ${notification.admin_notes}`}
              </div>
            ` : ''}
            <div class="notification-time">
              ${new Date(notification.created_at).toLocaleString()}
            </div>
          </div>
        `).join('');

        // Mark notifications as read
        return fetch('/mark_notifications_read/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
      })
      .then(() => {
        // Hide the notification indicator
        const indicator = document.getElementById('notificationIndicator');
        if (indicator) {
          indicator.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Error loading notifications:', error);
        container.innerHTML = '<div style="text-align: center; color: #ff6b6b;">Error loading notifications</div>';
      });
    }

    function openNotificationsModal() {
      console.log('Opening notifications modal...');
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.style.display = 'flex';
        loadNotifications();
      }
    }

    function closeNotificationsModal() {
      console.log('Closing notifications modal...');
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Set up notification event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up notification event listeners...');
      
      // Set up notification bell click handler
      const notificationBell = document.getElementById('notificationBell');
      if (notificationBell) {
        notificationBell.addEventListener('click', function(e) {
          console.log('Notification bell clicked');
          e.preventDefault();
          e.stopPropagation();
          openNotificationsModal();
        });
      }

      // Set up modal click-outside-to-close
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeNotificationsModal();
          }
        });
      }

      // Initial notifications check
      checkNotifications();
      
      // Set up periodic notifications check
      setInterval(checkNotifications, 30000); // Check every 30 seconds
    });

    // Add this new function to handle chat loading
    function loadChat(chatItem, event) {
      // Prevent default if it's an anchor tag
      if (event) {
        event.preventDefault();
      }
      
      // Get the chat URL and ID
      const chatUrl = chatItem.dataset.chatUrl;
      const chatId = chatItem.dataset.chatId;
      
      // Set the chat as active
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      chatItem.classList.add('active');
      
      // Remove unread indicator
      chatItem.classList.remove('has-unread');
      const unreadIndicator = chatItem.querySelector('.unread-indicator');
      if (unreadIndicator) {
        unreadIndicator.style.display = 'none';
      }
      
      // Show loading spinner in the messages container
      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.innerHTML = '<div class="loading-spinner-container"><div class="loading-spinner"></div></div>';
      
      // Fetch the chat details with AJAX
      fetch(chatUrl)
        .then(response => response.text())
        .then(html => {
          // Extract just the messages container content from the response
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newMessages = doc.querySelector('.messages-container').innerHTML;
          
          // Update the messages container
          messagesContainer.innerHTML = newMessages;
          
          // Initialize image attachment click handlers for the loaded chat
          setupImageAttachmentListeners();
          
          // Update the URL without refreshing the page
          history.pushState({}, '', chatUrl);
          
          // Scroll to the bottom
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // Update the chat header
          const chatHeader = document.querySelector('.chat-header');
          chatHeader.innerHTML = doc.querySelector('.chat-header').innerHTML;
        })
        .catch(error => {
          console.error('Error loading chat:', error);
          messagesContainer.innerHTML = '<div class="error-message">Error loading chat. Please try again.</div>';
        });
    }

    // Remove the chat context menu related functions and add these new functions
    function openUserActionsModal() {
      const modal = document.getElementById('userActionsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'block';
      backdrop.style.display = 'block';
      
      // Close modal when clicking outside
      backdrop.onclick = function() {
        closeUserActionsModal();
      };
    }

    function closeUserActionsModal() {
      const modal = document.getElementById('userActionsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'none';
      backdrop.style.display = 'none';
    }

    function handleDeleteChat() {
      const modal = document.getElementById('deleteConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'block';
      backdrop.style.display = 'block';
    }

    function closeDeleteConfirmation() {
      const modal = document.getElementById('deleteConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'none';
      backdrop.style.display = 'none';
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast-message ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Trigger reflow
      toast.offsetHeight;
      
      // Show toast
      toast.classList.add('show');
      
      // Hide and remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 3000);
      }, 3000);
    }

    function confirmDeleteChat() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) {
        showToast('No active chat found', 'error');
        return;
      }

      fetch('/delete_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: activeChatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove the chat item from the list
          const chatElement = document.querySelector(`[data-chat-id="${activeChatId}"]`);
          if (chatElement) {
            chatElement.remove();
          }
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close both modals
          closeDeleteConfirmation();
          closeUserActionsModal();
          
          showToast('Chat deleted successfully');
        } else {
          showToast('Failed to delete chat. Please try again.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to delete chat. Please try again.', 'error');
      });
    }

    // Close delete confirmation modal when clicking outside
    document.getElementById('modalBackdrop').addEventListener('click', function() {
      closeDeleteConfirmation();
    });

    // Close delete confirmation modal when pressing Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeDeleteConfirmation();
      }
    });

    // Block User Modal Functions
    function showBlockConfirmation() {
      document.getElementById('blockConfirmationModal').style.display = 'flex';
    }

    function closeBlockConfirmation() {
      document.getElementById('blockConfirmationModal').style.display = 'none';
    }

    function handleBlockUser() {
      showBlockConfirmation();
      }

    function confirmBlockUser() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) {
        showToast('No active chat found', 'error');
        return;
      }

      fetch('/block_user/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: activeChatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove the chat from the list
          const chatItem = document.querySelector(`[data-chat-id="${activeChatId}"]`);
          if (chatItem) {
            chatItem.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close both modals
          closeBlockConfirmation();
          closeUserActionsModal();
          
          // Show success message
          showToast('User blocked successfully', 'success');
        } else {
          showToast(data.message || 'Failed to block user', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to block user', 'error');
      });
    }

    // Add this new function to check if a user is blocked
    function checkIfUserIsBlocked(chatId) {
      return fetch('/check_if_user_is_blocked/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: chatId })
      })
      .then(response => response.json())
      .then(data => {
        return data.is_blocked;
      })
      .catch(error => {
        console.error('Error checking block status:', error);
        return false;
      });
    }

    // Add these new functions for attachment handling
    let selectedFile = null;

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const preview = document.getElementById('attachmentPreview');
        const fileName = document.getElementById('attachmentName');
        const fileSize = document.getElementById('attachmentSize');
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML = `
              <button class="remove-attachment" onclick="removeAttachment()">&times;</button>
              <img src="${e.target.result}" alt="Preview">
              <div class="file-info">
                <div class="file-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 16L8.586 11.414C9.367 10.633 10.633 10.633 11.414 11.414L16 16M14 14L15.586 12.414C16.367 11.633 17.633 11.633 18.414 12.414L20 14M6 20H18C19.105 20 20 19.105 20 18V6C20 4.895 19.105 4 18 4H6C4.895 4 4 4.895 4 6V18C4 19.105 4.895 20 6 20Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
            `;
          };
          reader.readAsDataURL(file);
        }
        
        preview.classList.add('show');
      }
    });

    function removeAttachment() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('attachmentPreview').classList.remove('show');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Modify the sendMessage function to handle attachments
    let isSendingMessage = false; // Add a flag to prevent duplicate submissions

    function sendMessage() {
      // Prevent duplicate submissions
      if (isSendingMessage) {
        console.log('Message already being sent, preventing duplicate submission');
        return;
      }

      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      const fileInput = document.getElementById('fileInput');
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      
      if (!activeChatId) {
        console.error('No active chat found');
        return;
      }
      
      // Don't send if both message and file are empty
      if (!message && !fileInput.files.length) {
        return;
      }

      // Set the flag to prevent duplicate submissions
      isSendingMessage = true;

      // Check if user is blocked before sending
      checkIfUserIsBlocked(activeChatId)
        .then(isBlocked => {
          if (isBlocked) {
            showToast('You cannot send messages to this user', 'error');
            isSendingMessage = false; // Reset flag
            return;
          }
          
          const formData = new FormData();
          formData.append('chat_id', activeChatId);
          formData.append('message', message);
          
          // Add attachment if present
          if (fileInput.files.length > 0) {
            formData.append('attachment', fileInput.files[0]);
          }
          
          // Send message with FormData
          fetch('/send_message/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            // Reset flag after response is received
            isSendingMessage = false;
            
            if (data.status === 'success') {
              // Remove the "No messages yet" prompt if it exists
              const noMessagesPrompt = document.getElementById('no-messages-prompt');
              if (noMessagesPrompt) {
                noMessagesPrompt.remove();
              }
              
              // Add the new message to the messages container
              const messagesContainer = document.querySelector('.messages-container');
              const messageDiv = document.createElement('div');
              messageDiv.className = 'message message-sent';
              messageDiv.dataset.messageId = data.message_id;
              messageDiv.dataset.senderId = "{{ request.user.id }}";
              messageDiv.setAttribute('oncontextmenu', 'showContextMenu(event, this)');
              
              // Create profile picture element
              const profilePicture = `
                <div class="message-pfp">
                  {% if request.user.profile_picture %}
                    <img src="{{ request.user.profile_picture.url }}" alt="Profile Picture">
                  {% else %}
                    <div class="pfp-initials">
                      {{ request.user.first_name|slice:":1" }}{{ request.user.last_name|slice:":1" }}
                    </div>
                  {% endif %}
                </div>
              `;
              
              // Create message content
              let messageContent = `
                <div class="message-content">
                  ${message}
              `;
              
              // Add attachment if present
              if (data.has_attachment) {
                if (data.attachment_type === 'image') {
                  messageContent += `
                    <div class="message-attachment">
                      <img src="${data.attachment_url}" alt="${data.attachment_name}" class="attachment-image">
                    </div>
                  `;
                } else {
                  messageContent += `
                    <div class="message-attachment">
                      <div class="file-icon">
                        ${getFileIcon(data.attachment_type)}
                      </div>
                      <div class="file-info">
                        <div class="file-name">${data.attachment_name}</div>
                        <a href="${data.attachment_url}" target="_blank" class="file-link">Download</a>
                      </div>
                    </div>
                  `;
                }
              }
              
              // Add message time with read receipt
              messageContent += `
                  <div class="message-time">
                    ${data.sent_at}
                    <div class="message-read-status" data-message-id="${data.message_id}">
                      <span class="read-receipt" id="read-receipt-${data.message_id}">
                        <span class="read-receipt-icon">&#10003;</span>
                      </span>
                    </div>
                  </div>
              `;
              
              messageDiv.innerHTML = profilePicture + messageContent;
              messagesContainer.appendChild(messageDiv);
              
              // Set up image attachment click listeners for the new message
              if (data.has_attachment && data.attachment_type === 'image') {
                const newImage = messageDiv.querySelector('.message-attachment img');
                if (newImage) {
                  newImage.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openImageViewer(this.src);
                  });
                }
              }
              
              // Update chat preview
              const activeChatItem = document.querySelector('.chat-item.active');
              if (activeChatItem) {
                const previewElement = activeChatItem.querySelector('.chat-item-preview');
                if (previewElement) {
                  if (message) {
                    previewElement.textContent = message;
                  } else if (data.has_attachment) {
                    previewElement.textContent = `Sent ${data.attachment_name}`;
                  }
                }
                
                const timeElement = activeChatItem.querySelector('.chat-item-time');
                if (timeElement) {
                  timeElement.textContent = data.sent_at;
                }
              }
              
              // Clear the input and attachment
              messageInput.value = '';
              removeAttachment();
              
              // Scroll to the bottom
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
              showToast(data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Error sending message:', error);
            showToast('Error sending message', 'error');
            isSendingMessage = false; // Reset flag on error
          });
        });
    }

    // Helper function to get file icon based on type
    function getFileIcon(type) {
      switch(type) {
        case 'pdf':
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 18C12 17.4 11.6 17 11 17C10.4 17 10 17.4 10 18C10 18.6 10.4 19 11 19C11.6 19 12 18.6 12 18Z" fill="white"/>
            <path d="M12 13C12 12.4 11.6 12 11 12C10.4 12 10 12.4 10 13V16C10 16.6 10.4 17 11 17C11.6 17 12 16.6 12 16V13Z" fill="white"/>
          </svg>`;
        case 'doc':
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 13H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 17H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 9H9H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        default:
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
      }
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function handleAttachment(event) {
      const file = event.target.files[0];
      const messageInput = document.getElementById('messageInput');
      
      if (file) {
        // Update the placeholder text to show the selected file
        messageInput.placeholder = `Sending: ${file.name}`;
        
        // Add a small filename display near the input
        const fileNameDisplay = document.createElement('div');
        fileNameDisplay.id = 'fileNameDisplay';
        fileNameDisplay.className = 'file-name-display';
        fileNameDisplay.innerHTML = `
          <span class="file-name">${file.name}</span>
          <button class="remove-file" onclick="removeAttachment()"></button>
        `;
        
        // Remove any existing file name display
        const existingDisplay = document.getElementById('fileNameDisplay');
        if (existingDisplay) {
          existingDisplay.remove();
        }
        
        // Add the file name display to the message input container
        const messageInputContainer = document.querySelector('.input-container');
        messageInputContainer.insertBefore(fileNameDisplay, messageInput);
        
        // Adjust the input padding to make room for the file display
        messageInput.style.paddingRight = '80px';
      }
    }

    function removeAttachment() {
      const fileInput = document.getElementById('fileInput');
      const messageInput = document.getElementById('messageInput');
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      
      fileInput.value = '';
      messageInput.placeholder = 'Type a message...';
      messageInput.style.paddingRight = '';
      
      if (fileNameDisplay) {
        fileNameDisplay.remove();
      }
    }

    // Add this new initialization function
    function initializeChatInterface() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      const messagesContainer = document.querySelector('.messages-container');
      
      if (activeChatId) {
        // Show input area if there's an active chat
        if (inputArea) {
          inputArea.style.display = 'block';
        }
        
        // Ensure messages are visible
        if (messagesContainer) {
          messagesContainer.style.display = 'flex';
          scrollToBottom();
        }
      }
    }

    // Update the DOMContentLoaded event listener
    document.addEventListener("DOMContentLoaded", function() {
      initializeChatInterface();
      
      // Set up other event listeners
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleAttachment);
      }
      
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.addEventListener('keydown', function(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
      }
    });

    // Also call initialization on window load as a fallback
    window.addEventListener('load', initializeChatInterface);

    // Add this to your existing JavaScript
    function openImageViewer(imageUrl) {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const fullscreenImage = document.getElementById('fullscreen-image');
      const downloadBtn = document.getElementById('download-image-btn');
      const navbar = document.querySelector('.navbar');
      
      fullscreenImage.src = imageUrl;
      
      // Set up download button
      if (downloadBtn) {
        downloadBtn.href = imageUrl;
        // Extract filename from URL to use as download name
        const fileName = imageUrl.split('/').pop();
        downloadBtn.setAttribute('download', fileName);
      }
      
      // Slide navbar up
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(-100%)';
      }
      
      // Show the viewer with transition
      viewer.style.display = 'block';
      // Trigger reflow to ensure the transition works
      viewer.offsetHeight;
      viewer.classList.add('visible');
      
      // Prevent scrolling on the body when modal is open
      document.body.style.overflow = 'hidden';
    }

    function closeImageViewer() {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const navbar = document.querySelector('.navbar');
      
      // Slide navbar down
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(0)';
      }
      
      // Hide the viewer with transition
      viewer.classList.remove('visible');
      
      // Wait for the transition to complete before hiding
      setTimeout(() => {
        viewer.style.display = 'none';
      }, 300); // Match the transition duration (0.3s)
      
      // Re-enable scrolling on the body
      document.body.style.overflow = 'auto';
    }

    // Close the image viewer when clicking outside the image
    document.getElementById('fullscreen-image-viewer').addEventListener('click', function(event) {
      if (event.target === this) {
        closeImageViewer();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && document.getElementById('fullscreen-image-viewer').style.display === 'block') {
        closeImageViewer();
      }
    });

    // Add click event listeners to all image attachments
    document.addEventListener('DOMContentLoaded', function() {
      // Initial setup for existing images
      setupImageAttachmentListeners();
    });

    // Function to set up click listeners for image attachments
    function setupImageAttachmentListeners() {
      const imageAttachments = document.querySelectorAll('.message-attachment img');
      imageAttachments.forEach(img => {
        img.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openImageViewer(this.src);
        });
      });
    }

    // Update this function to add click listeners to new image attachments
    // This should be called when new messages are added to the chat
    function appendMessage(data) {
      // Your existing appendMessage code
      
      // After appending the message, setup listeners for any new image attachments
      setupImageAttachmentListeners();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Set up chat interface
      initializeChatInterface();
      
      // Set up image attachment listeners for existing images
      setupImageAttachmentListeners();
      
      // Check for notifications
      checkNotifications();
      
      // Check initial read receipts
      checkReadReceipts();
      
      // Start read receipt polling
      startReadReceiptPolling();
      
      // Mark initial messages as read
      if (document.querySelector('.chat-item.active')) {
        markMessagesAsRead();
      }
      
      // Remove the reference to startNotificationPolling which is not defined and causing duplicate messages
      // if (typeof isUserAuthenticated !== 'undefined' && isUserAuthenticated) {
      //   startNotificationPolling();
      // }
    });

    // Mark all messages in the current chat as read when it's viewed
    function markMessagesAsRead() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) return;
      
      fetch(`/mark_messages_read/${activeChatId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          console.log(`Marked ${data.count} messages as read`);
        }
      })
      .catch(error => {
        console.error('Error marking messages as read:', error);
      });
    }

    // Function to check read receipts for sent messages
    function checkReadReceipts() {
      // Get all sent messages in the active chat
      const sentMessages = document.querySelectorAll('.message-sent');
      if (!sentMessages.length) return;
      
      // Check read status for each sent message
      sentMessages.forEach(message => {
        const messageId = message.dataset.messageId;
        if (!messageId) return;
        
        fetch(`/check_message_status/${messageId}/`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const readReceipt = document.getElementById(`read-receipt-${messageId}`);
            if (readReceipt) {
              if (data.is_read) {
                // Message is read - blue tick
                readReceipt.classList.add('read');
              } else {
                // Message is delivered but not read - grey tick
                readReceipt.classList.remove('read');
              }
            }
          }
        })
        .catch(error => {
          console.error(`Error checking read status for message ${messageId}:`, error);
        });
      });
    }

    // Start a polling mechanism to check read receipts
    function startReadReceiptPolling() {
      // Check read receipts more frequently for better responsiveness
      setInterval(checkReadReceipts, 2000); // Check every 2 seconds
    }

    // Modify the loadChat function to mark messages as read when a chat is loaded
    function loadChat(chatItem, event) {
      // Prevent default if it's an anchor tag
      if (event) {
        event.preventDefault();
      }
      
      // Get the chat URL and ID
      const chatUrl = chatItem.dataset.chatUrl;
      const chatId = chatItem.dataset.chatId;
      
      // Set the chat as active
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      chatItem.classList.add('active');
      
      // Remove unread indicator
      chatItem.classList.remove('has-unread');
      const unreadIndicator = chatItem.querySelector('.unread-indicator');
      if (unreadIndicator) {
        unreadIndicator.style.display = 'none';
      }
      
      // Show loading spinner in the messages container
      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.innerHTML = '<div class="loading-spinner-container"><div class="loading-spinner"></div></div>';
      
      // Fetch the chat details with AJAX
      fetch(chatUrl)
        .then(response => response.text())
        .then(html => {
          // Extract just the messages container content from the response
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newMessages = doc.querySelector('.messages-container').innerHTML;
          
          // Update the messages container
          messagesContainer.innerHTML = newMessages;
          
          // Initialize image attachment click handlers for the loaded chat
          setupImageAttachmentListeners();
          
          // Mark all messages in this chat as read
          markMessagesAsRead();
          
          // Start checking read receipts
          checkReadReceipts();
          
          // Update the URL without refreshing the page
          history.pushState({}, '', chatUrl);
          
          // Scroll to the bottom
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // Update the chat header
          const chatHeader = document.querySelector('.chat-header');
          chatHeader.innerHTML = doc.querySelector('.chat-header').innerHTML;
        })
        .catch(error => {
          console.error('Error loading chat:', error);
          messagesContainer.innerHTML = '<div class="error-message">Error loading chat. Please try again.</div>';
        });
    }
  </script>

  {% endblock %}
</div>
