{% extends "base.html" %}
{% load tz %}
{% load chat_filters %}
{% load static %}
{% block content %}
<script>
// Global search function that can be called by the button
function performSearch() {
  console.log("Search function called");
  const searchInput = document.getElementById('contactSearch');
  if (!searchInput) {
    console.error("Search input not found");
    return false;
  }
  
  const searchQuery = searchInput.value.toLowerCase().trim();
  console.log("Search query:", searchQuery);
  
  // Get all chat items
  const chatItems = document.querySelectorAll('.chat-item');
  console.log("Total chat items:", chatItems.length);
  
  let matchCount = 0;
  
  // Loop through each chat item
  chatItems.forEach(function(chatItem) {
    const nameElement = chatItem.querySelector('.chat-item-name');
    if (!nameElement) return;
    
    const chatName = nameElement.textContent.toLowerCase().trim();
    console.log("Checking chat:", chatName);
    
    // Simple search - just check if name contains query
    if (searchQuery === '' || chatName.includes(searchQuery)) {
      chatItem.style.display = 'flex';
      matchCount++;
      console.log("Match found:", chatName);
    } else {
      chatItem.style.display = 'none';
    }
  });
  
  console.log("Search complete. Found " + matchCount + " matches.");
  
  // Show/hide "no results" message
  let noResultsMsg = document.getElementById('noSearchResults');
  if (matchCount === 0 && searchQuery !== '') {
    if (!noResultsMsg) {
      noResultsMsg = document.createElement('div');
      noResultsMsg.id = 'noSearchResults';
      noResultsMsg.style.textAlign = 'center';
      noResultsMsg.style.color = '#666';
      noResultsMsg.style.padding = '20px';
      noResultsMsg.textContent = 'No matching contacts found';
      const chatList = document.querySelector('.chat-list');
      if (chatList) chatList.appendChild(noResultsMsg);
    } else {
      noResultsMsg.style.display = 'block';
    }
  } else if (noResultsMsg) {
    noResultsMsg.style.display = 'none';
  }
  
  // If there's exactly one match, highlight it
  if (matchCount === 1 && searchQuery !== '') {
    const matchedItem = Array.from(chatItems).find(item => item.style.display === 'flex');
    if (matchedItem) {
      matchedItem.style.transition = 'background-color 0.3s';
      matchedItem.style.backgroundColor = '#3a5998';
      setTimeout(() => {
        matchedItem.style.backgroundColor = '';
        // Open the matched chat
        matchedItem.click();
      }, 800);
    }
  }
  
  return false; // Prevent form submission
}
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Arial", sans-serif;
  }
  .chat-container {
    background-color: black;
    color: white;
    height: calc(100vh - 60px);
    display: flex;
    overflow: hidden;
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
  }

  /* Chat List Panel */
  .chat-list-panel {
    width: 30%;
    height: 100%;
    background-color: #1a1a1a;
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    margin: 10px;
  }

  .chat-list-title {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #333;
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
  }

  .chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
  }

  .chat-item:hover {
    background-color: #2a2a2a;
  }

  .chat-item.active {
    background-color: #333;
  }

  .chat-item-pfp {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444; /* Fallback background for initials */
    font-size: 20px;
    font-weight: bold;
    color: white;
    margin-right: 15px;
    flex-shrink: 0;
  }

  .pfp-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .pfp-initials {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  .chat-item-details {
    flex: 1;
    overflow: hidden;
    margin-right: 40px; /* Add space for the unread indicator */
  }

  .chat-item-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .chat-item-preview {
    color: #aaa;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chat-item-time {
    position: absolute;
    bottom: 12px;
    right: 12px;
    font-size: 12px;
    color: #666;
  }

  /* Chat Area */
  .chat-area {
    flex: 1;
    background-color: #1a1a1a;
    border-radius: 15px;
    margin: 10px;
    margin-left: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Add this to prevent content overflow */
  }

  .chat-header {
    padding: 20px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    background-color: #1a1a1a;
  }

  .chat-header-pfp {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    margin-right: 15px;
  }

  .chat-header-info {
    flex: 1;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
  }

  .chat-header-info:hover {
    background-color: #2a2a2a;
  }

  .chat-header-name {
    font-size: 18px;
    font-weight: bold;
  }

  .chat-header-subtitle {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }

  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background-color: #1a1a1a;
    align-items: stretch;
    min-height: 0; /* Add this to ensure proper flex behavior */
    height: 100%; /* Add this to ensure container takes full height */
  }

  .messages-container:has(.start-message) {
    justify-content: center;
    align-items: center;
  }

  .start-message {
    text-align: center;
    color: #aaa;
    font-size: 24px;
    max-width: 80%;
    margin: 0 auto;
    margin-bottom: 20px;
    animation: fadeIn 0.8s ease-in-out;
  }

  .message {
    max-width: 70%;
    padding: 12px 15px;
    border-radius: 15px;
    margin-bottom: 15px;
    word-wrap: break-word;
    position: relative;
    width: fit-content;
    cursor: context-menu;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .message-pfp {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    flex-shrink: 0;
  }

  .message-pfp img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .message-pfp .pfp-initials {
    font-size: 14px;
    font-weight: bold;
    color: white;
  }

  .message-content {
    flex: 1;
  }

  .message-attachment {
    margin-top: 8px;
    padding: 8px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    max-width: 300px;
  }

  .attachment-image {
    max-width: 100%;
    max-height: 200px;
    border-radius: 4px;
  }

  .file-icon {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }

  .file-info {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .file-name {
    font-size: 14px;
    word-break: break-word;
    text-align: center;
    max-width: 280px;
    margin-bottom: 5px;
  }

  .file-link {
    color: #3498db;
    text-decoration: none;
    font-size: 12px;
    padding: 3px 10px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .file-link:hover {
    background-color: rgba(0, 0, 0, 0.3);
    text-decoration: underline;
  }

  .message-attachment .file-info {
    background: rgba(0, 0, 0, 0.5);
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .message-attachment .file-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #444;
    border-radius: 4px;
  }

  .message-attachment .file-name {
    color: white;
    font-size: 14px;
    word-break: break-all;
  }

  .message-attachment .file-size {
    color: #aaa;
    font-size: 12px;
    white-space: nowrap;
  }

  .attachment-preview {
    display: none;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 8px;
    position: relative;
  }

  .attachment-preview.show {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .attachment-preview img {
    max-width: 100px;
    max-height: 100px;
    border-radius: 4px;
  }

  .attachment-preview .file-info {
    flex: 1;
  }

  .attachment-preview .remove-attachment {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }

  .attachment-preview .remove-attachment:hover {
    background: rgba(255, 0, 0, 0.7);
  }

  #fileInput {
    display: none;
  }

  .message.deleted {
    font-style: italic;
    color: #666;
  }

  .message-sent {
    background-color: #2a2a2a;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
    flex-direction: row-reverse;
  }

  .message-received {
    background-color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 5px;
  }

  .message-time {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
    text-align: right;
    display: inline-flex;
    align-items: center;
  }

  .message-read-status {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    margin-left: 4px;
  }

  .read-receipt {
    display: inline-flex;
    align-items: center;
  }

  .read-receipt-icon {
    font-size: 14px;
    color: #888;
  }

  .read-receipt.read .read-receipt-icon {
    color: #2196f3;
  }

  /* Remove unnecessary text elements */
  .read-receipt-text {
    display: none;
  }

  .input-area {
    padding: 15px;
    border-top: 1px solid #333;
    display: flex;
    width: 100%;
    background-color: #1a1a1a;
    position: relative; /* Add this to ensure proper stacking */
    z-index: 1; /* Add this to ensure proper stacking */
  }
  
  .chat-footer {
    width: 100%;
    display: flex;
  }

  .input-container {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
  }

  .message-input {
    flex: 1;
    width: 100%;
    background-color: #2a2a2a;
    border: none;
    border-radius: 20px;
    padding: 12px 15px;
    color: white;
    outline: none;
    margin-right: 10px;
  }

  .input-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .attach-button,
  .send-button {
    background-color: #333;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    position: relative;
  }

  .attach-button:hover,
  .send-button:hover {
    background-color: #444;
  }

  .attach-button svg {
    width: 20px;
    height: 20px;
  }

  /* Add tooltip styles */
  .tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 5px 10px;
    background-color: #333;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    margin-bottom: 5px;
    pointer-events: none;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
  }

  .attach-button:hover .tooltip,
  .send-button:hover .tooltip,
  .location-button:hover .tooltip {
    opacity: 1;
    visibility: visible;
  }

  .add-contact-button {
    display: block;
    margin: 0 auto;
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(135deg, #333 0%, #444 100%);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    width: auto;
    min-width: 120px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    animation: slideUp 0.5s ease-out 0.3s both;
  }

  .add-contact-button:hover {
    background: linear-gradient(135deg, #444 0%, #555 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  @keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  @keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #1a1a1a;
  }

  ::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #444;
  }

  .dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .dialog-box {
    background-color: #1a1a1a;
    padding: 25px;
    border-radius: 15px;
    width: 350px;
    text-align: center;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
  }

  .dialog-title {
    font-size: 20px;
    margin-bottom: 15px;
    color: white;
  }

  .input-field {
    width: 100%;
    padding: 12px 15px;
    border-radius: 20px;
    border: none;
    background-color: #2a2a2a;
    color: white;
    outline: none;
    font-size: 14px;
  }

  #search-result {
    width: 100%;
    margin-top: 10px;
  }

  .search-result-item {
    width: 100%;
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-top: 10px;
    border-radius: 10px;
    background-color: #2a2a2a;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .search-result-item:hover {
    background-color: #333;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .add-friend-btn {
    background: #333;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 14px;
  }

  .add-friend-btn:hover {
    background: #444;
  }

  .dialog-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 15px;
  }

  .dialog-button {
    padding: 10px 20px;
    background-color: #333;
    border: none;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
    flex: 1;
    font-size: 14px;
  }

  .dialog-button:hover {
    background-color: #444;
  }

  /* Add this to your existing styles */
  .context-menu {
    position: fixed;
    background: #2a2a2a;
    border-radius: 8px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 9999;
  }

  .context-menu-header {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    border-bottom: 1px solid #444;
    margin-bottom: 4px;
  }

  .context-menu-pfp {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #444;
    margin-right: 10px;
  }

  .context-menu-pfp img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .context-menu-pfp .pfp-initials {
    font-size: 14px;
    font-weight: bold;
    color: white;
  }

  .context-menu-name {
    color: white;
    font-weight: bold;
  }

  .context-menu-item {
    padding: 8px 15px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s;
  }

  .context-menu-item:hover {
    background-color: #333;
  }

  .context-menu-item.danger {
    color: #ff6b6b;
  }

  .context-menu-divider {
    height: 1px;
    background-color: #444;
    margin: 4px 0;
  }

  .unread-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #4CAF50;
    display: none;
  }

  .chat-item.has-unread .unread-indicator {
    display: block;
  }

  .unread-count {
    display: none;
  }

  /* Add this after your existing styles */
  .notifications-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .notifications-content {
    background: #1e1e1e;
    padding: 30px;
    border-radius: 15px;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }

  .notifications-header {
    margin-bottom: 20px;
    color: white;
    font-size: 24px;
    text-align: center;
  }

  .notification-item {
    background: #2a2a2a;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s ease;
  }

  .notification-item:hover {
    transform: translateY(-2px);
  }

  .notification-item.warning {
    border-left: 4px solid #ffa500;
  }

  .notification-item.info {
    border-left: 4px solid #3498db;
  }

  /* Special styling for broadcast notifications */
  .notification-item.broadcast {
    border: 1px solid #ffd700;
    background: linear-gradient(to right, #2a2a2a, #1a1a1a);
  }

  #notificationIndicator {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 8px;
    height: 8px;
    background-color: #ffd700;
    border-radius: 50%;
    display: none;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.2);
      opacity: 0.8;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .notification-type {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .notification-message {
    margin: 10px 0;
  }

  .notification-admin-notes {
    font-size: 0.9em;
    color: #888;
    margin-top: 5px;
  }

  .notification-time {
    font-size: 0.8em;
    color: #666;
    margin-top: 5px;
  }

  .notifications-close {
    position: absolute;
    top: 10px;
    right: 15px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
  }

  /* Add these new styles */
  .user-actions-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1a1a1a;
    border-radius: 15px;
    padding: 20px;
    z-index: 1001;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .user-actions-content {
    position: relative;
  }

  .user-actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #333;
    text-align: center;
    position: relative;
    padding-right: 30px; /* Add space for the close button */
  }

  .user-actions-header h2 {
    margin: 0;
    color: white;
    font-size: 20px;
    width: 100%;
    text-align: center;
  }

  .close-modal {
    color: #666;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
  }

  .close-modal:hover {
    color: white;
  }

  .user-info-section, .group-info-section {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }

  .user-avatar, .group-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .user-avatar img, .group-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-initials {
    color: white;
    font-size: 24px;
    font-weight: bold;
  }

  .user-details h3, .group-details h3 {
    margin: 0;
    color: white;
    font-size: 18px;
  }

  .user-username, .group-subtitle {
    color: #666;
    font-size: 14px;
    margin-top: 4px;
    text-align: left;
  }

  .group-members-section {
    margin-bottom: 20px;
  }

  .group-members-section h4 {
    color: white;
    font-size: 16px;
    margin: 0 0 10px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #333;
  }

  .group-members-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .group-member {
    display: flex;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 5px;
    transition: background-color 0.2s;
  }

  .group-member:hover {
    background-color: #252525;
  }

  .member-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 10px;
    background: #444;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .member-initials {
    color: white;
    font-size: 16px;
    font-weight: bold;
  }

  .member-details {
    flex: 1;
  }

  .member-name {
    color: white;
    font-size: 14px;
    margin-bottom: 2px;
  }

  .member-username {
    color: #666;
    font-size: 12px;
  }

  .member-role {
    background-color: #3498db;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    margin-left: 5px;
  }

  .user-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .action-button {
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
    background-color: #b02c37;
    width: 100%;
  }

  .action-button.delete {
    background-color: #2a2a2a;
  }

  .action-button.delete:hover {
    background-color: #dc3545;
  }

  .action-button.block {
    background-color: #2a2a2a;
  }

  .action-button.block:hover {
    background-color: #6c757d;
  }

  .action-button.archive {
    background-color: #2a2a2a;
  }

  .action-button.archive:hover {
    background-color: #4a4a4a;
  }

  .modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }

  /* Add these new styles before the closing style tag */
  .delete-confirmation-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1a1a1a;
    border-radius: 15px;
    padding: 25px;
    z-index: 1002;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .delete-confirmation-content {
    text-align: center;
  }

  .delete-confirmation-title {
    color: #ff6b6b;
    font-size: 24px;
    margin-bottom: 15px;
  }

  .delete-confirmation-message {
    color: #fff;
    margin-bottom: 25px;
    line-height: 1.5;
  }

  .delete-confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .delete-confirmation-button {
    padding: 10px 25px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .delete-confirmation-button.cancel {
    background: #333;
    color: white;
  }

  .delete-confirmation-button.cancel:hover {
    background: #444;
  }

  .delete-confirmation-button.confirm {
    background: #ff6b6b;
    color: white;
  }

  .delete-confirmation-button.confirm:hover {
    background: #ff5252;
  }

  .toast-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    z-index: 10000;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .toast-message.show {
    opacity: 1;
  }

  .toast-message.success {
    background: #4CAF50;
  }

  .toast-message.error {
    background: #ff6b6b;
  }

  /* Block User Modal Styles */
  .block-confirmation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1003;
    justify-content: center;
    align-items: center;
  }

  .block-confirmation-content {
    background-color: #1a1a1a;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .block-confirmation-content h3 {
    margin: 0 0 1rem 0;
    color: #ff6b6b;
    font-size: 1.5rem;
    text-align: center;
  }

  .block-confirmation-content p {
    margin: 0 0 1.5rem 0;
    color: #fff;
    line-height: 1.5;
    text-align: center;
  }

  .block-confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .block-confirmation-buttons button {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 14px;
  }

  .block-confirmation-buttons button.cancel {
    background-color: #333;
    color: white;
  }

  .block-confirmation-buttons button.cancel:hover {
    background-color: #444;
  }

  .block-confirmation-buttons button.confirm {
    background-color: #ff6b6b;
    color: white;
  }

  .block-confirmation-buttons button.confirm:hover {
    background-color: #ff5252;
  }

  /* Add this CSS code */
  .file-name-display {
    position: absolute;
    right: 100px;
    top: 50%;
    transform: translateY(-50%);
    background-color: #444;
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 12px;
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
  }

  .file-name {
    margin-right: 5px;
    color: white;
  }

  .remove-file {
    background: none;
    border: none;
    color: #aaa;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    padding: 0 2px;
  }

  .remove-file:hover {
    color: white;
  }

  .input-container {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
  }

  /* Fullscreen image viewer styles */
  .fullscreen-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    opacity: 0;
    transition: background-color 0.3s ease, backdrop-filter 0.3s ease, opacity 0.3s ease;
  }

  .fullscreen-modal.visible {
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    opacity: 1;
  }

  .fullscreen-modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
  }

  #fullscreen-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .fullscreen-modal.visible #fullscreen-image {
    opacity: 1;
    transform: scale(1);
  }

  .close-modal {
    position: absolute;
    top: 15px;
    right: 25px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
    transition: color 0.2s;
  }

  .close-modal:hover {
    color: #bbb;
  }

  .download-button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s, opacity 0.3s ease, transform 0.3s ease;
    opacity: 0;
    transform: translateY(10px);
  }

  .fullscreen-modal.visible .download-button {
    opacity: 1;
    transform: translateY(0);
  }

  .download-button:hover {
    background-color: #45a049;
  }

  /* Add pointer cursor to image attachments */
  .message-attachment img {
    cursor: pointer;
    transition: transform 0.2s;
  }

  .message-attachment img:hover {
    transform: scale(1.03);
  }

  /* Pinned message styles */
  .pinned-message-container {
    display: none;
    background-color: #2a2a2a;
    border-bottom: 1px solid #444;
    padding: 10px 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .pinned-message-container:hover {
    background-color: #333;
  }

  .pinned-message-container.active {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .pinned-message-icon {
    color: #3498db;
    font-size: 16px;
  }

  .pinned-message-content {
    flex: 1;
    font-size: 14px;
    color: #ddd;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: calc(100% - 70px);
  }

  .pinned-message-unpin {
    margin-left: auto;
    background: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .pinned-message-unpin:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #fff;
  }

  #groupChatName{
    text-align: center !important;
  }

  .location-button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: color 0.2s;
  }

  .location-button:hover {
    color: #3498db;
  }

  .location-button i {
    font-size: 20px;
  }

  /* Update CSS for location message */
  .location-message {
    margin: 5px 0;
    max-width: 300px;
    background: #2a2a2a;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .location-preview {
    position: relative;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .location-preview:hover {
    transform: scale(1.01);
  }

  .location-preview img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }

  .location-coordinates {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
    color: white;
    padding: 20px 10px 10px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .location-coordinates i {
    font-size: 14px;
  }

  /* Add this to your CSS styles */
  #searchButton {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
</style>

<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  rel="stylesheet"
/>

<div class="chat-container">
  <!-- Add this right after the chat-container div -->
  <div id="message-context-menu" class="context-menu">
    <div class="context-menu-header">
      <div class="context-menu-pfp" id="contextMenuPfp">
        <!-- Profile picture will be set dynamically -->
      </div>
      <div class="context-menu-name" id="contextMenuName">
        <!-- Name will be set dynamically -->
      </div>
    </div>
    <div class="context-menu-item" onclick="pinMessage(this)" data-message-id="">
      Pin Message
    </div>
    <div class="context-menu-item" onclick="copyMessage(this)" data-message-id="">
      Copy Message
    </div>
    <div class="context-menu-item" onclick="deleteMessageForMe(this)" data-message-id="">
      Delete for me
    </div>
    <div class="context-menu-item danger sender-only" onclick="deleteMessageForEveryone(this)" data-message-id="">
      Delete for everyone
    </div>
    <div class="context-menu-item danger" onclick="reportMessage(this)" data-message-id="">
      Report Message
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="hideContextMenu()">
      Close
    </div>
  </div>

  <!-- Chat List Panel (30% width) -->
  <div class="chat-list-panel">
    <div class="chat-list-title">Chats</div>
    
    <!-- Search bar for contacts -->
    <div class="search-container" style="margin-bottom: 15px; position: relative;">
      <input type="text" id="contactSearch" placeholder="Search contacts..." 
             style="width: 100%; padding: 10px; padding-left: 35px; padding-right: 35px; border-radius: 20px; border: none; 
                    background-color: #2a2a2a; color: white; font-size: 14px; outline: none;"
             onkeydown="if(event.key==='Enter'){event.preventDefault();performSearch();return false;}">
      <i class="fa-solid fa-search" 
         style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
      <button type="button" id="searchButton" onclick="performSearch();return false;"
              style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); 
                     background-color: #007bff; color: white; border: none; border-radius: 50%; 
                     width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <i class="fa-solid fa-arrow-right" style="font-size: 12px;"></i>
      </button>
    </div>
    
    <div class="chat-list">
      <!-- Debug information -->
      <div style="display: none;">
        Current user: {{ request.user.username }}
        Number of chats: {{ chats|length }}
      </div>
      
      {% if chats %}
        {% for chat in chats %}
        <!-- Debug information for each chat -->  
        <div style="display: none;">
          Chat ID: {{ chat.id }}
          Sender: {{ chat.sender.username }}
          Recipient: {{ chat.recipient.username }}
        </div>
        <div
          class="chat-item {% if active_chat and chat.id == active_chat.id %} active {% endif %}{% if chat.unread_count > 0 %} has-unread {% endif %}"
          data-chat-url="{% url 'chat_detail' chat.id %}"
          data-chat-id="{{ chat.id }}"
          onclick="loadChat(this, event)">
          <div class="chat-item-pfp">
            {% if chat.sender == request.user %}
              {% if chat.recipient_profile_pic %}
                <img
                  src="{{ chat.recipient_profile_pic }}"
                  alt="Profile Picture"
                  class="pfp-image"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="pfp-initials" style="display: none;">
                  {{ chat.recipient.first_name|slice:":1" }}{{ chat.recipient.last_name|slice:":1" }}
                </div>
              {% else %}
                <div class="pfp-initials">
                  {{ chat.recipient.first_name|slice:":1" }}{{ chat.recipient.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% else %}
              {% if chat.sender_profile_pic %}
                <img
                  src="{{ chat.sender_profile_pic }}"
                  alt="Profile Picture"
                  class="pfp-image"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="pfp-initials" style="display: none;">
                  {{ chat.sender.first_name|slice:":1" }}{{ chat.sender.last_name|slice:":1" }}
                </div>
              {% else %}
                <div class="pfp-initials">
                  {{ chat.sender.first_name|slice:":1" }}{{ chat.sender.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% endif %}
          </div>
          <div class="chat-item-details">
            <div class="chat-item-name"
                 data-first-name="{% if chat.sender == request.user %}{{ chat.recipient.first_name }}{% else %}{{ chat.sender.first_name }}{% endif %}"
                 data-last-name="{% if chat.sender == request.user %}{{ chat.recipient.last_name }}{% else %}{{ chat.sender.last_name }}{% endif %}">
              {% if chat.sender == request.user %}
                {{ chat.recipient.first_name }} {{ chat.recipient.last_name }}
              {% else %}
                {{ chat.sender.first_name }} {{ chat.sender.last_name }}
              {% endif %}
            </div>
            <div class="chat-item-preview" style="display: none;">
              {{ chat.last_message|truncatewords:10 }}
            </div>
          </div>
          <div class="chat-item-time">
            {{ chat.updated_at|localtime|date:"g:i A" }}
          </div>
          <div class="unread-indicator"></div>
        </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; color: #666; padding: 20px;">
          No chats yet. Add a friend to start chatting!
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Chat Area (70% width) -->
  <div class="chat-area">
    <div class="chat-header">
      {% if active_chat %}
      <div class="chat-header-info" onclick="openUserActionsModal()" 
           data-username="{% if active_chat.sender == request.user %}{{ active_chat.recipient.username }}{% else %}{{ active_chat.sender.username }}{% endif %}"
           data-has-profile-picture="{% if active_chat.sender == request.user %}{% if active_chat.recipient.profile_picture %}true{% else %}false{% endif %}{% else %}{% if active_chat.sender.profile_picture %}true{% else %}false{% endif %}{% endif %}"
           data-profile-picture="{% if active_chat.sender == request.user %}{% if active_chat.recipient.profile_picture %}{{ active_chat.recipient.profile_picture.url }}{% endif %}{% else %}{% if active_chat.sender.profile_picture %}{{ active_chat.sender.profile_picture.url }}{% endif %}{% endif %}">
          <div class="chat-header-name">
            {% if active_chat.sender == request.user %}
              {{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}
            {% else %}
              {{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}
            {% endif %}
          </div>
          <div class="chat-header-subtitle">Click for actions</div>
        </div>
      {% endif %}
    </div>
    
    <!-- Pinned message container -->
    <div id="pinnedMessageContainer" class="pinned-message-container" onclick="scrollToPinnedMessage()">
      <div class="pinned-message-icon">
        <i class="fa-solid fa-map-pin"></i>
      </div>
      <div id="pinnedMessageContent" class="pinned-message-content"></div>
      <button class="pinned-message-unpin" onclick="unpinMessage(event)">
        Unpin
      </button>
    </div>
    
    <div class="messages-container">
      {% if active_chat %}
        {% if messages %}
          {% for message in messages %}
            <div class="message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %} {% if message.deleted_for_everyone %}deleted{% endif %}"
                 data-message-id="{{ message.id }}"
                 data-sender-id="{{ message.sender.id }}"
                 oncontextmenu="showContextMenu(event, this)"
                 {% if message.deleted_for.all|contains:request.user %}style="display: none;"{% endif %}>
              <div class="message-pfp">
                {% if message.sender.profile_picture %}
                  <img src="{{ message.sender.profile_picture.url }}" alt="Profile Picture">
                {% else %}
                  <div class="pfp-initials">
                    {{ message.sender.first_name|slice:":1" }}{{ message.sender.last_name|slice:":1" }}
                  </div>
                {% endif %}
              </div>
              <div class="message-content">
                {% if message.deleted_for_everyone %}
                  <i>Message deleted</i>
                {% else %}
                  {% if "location-message" in message.content %}
                    {{ message.content|safe }}
                  {% else %}
                    {{ message.content }}
                  {% endif %}
                  {% if message.attachment %}
                    {% if message.attachment_type == 'image' %}
                      <div class="message-attachment">
                        <img src="{{ message.attachment.url }}" alt="{{ message.attachment_name }}" class="attachment-image">
                      </div>
                    {% else %}
                      <div class="message-attachment">
                        <div class="file-icon">
                          {% if message.attachment_type == 'pdf' %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M12 18C12 17.4 11.6 17 11 17C10.4 17 10 17.4 10 18C10 18.6 10.4 19 11 19C11.6 19 12 18.6 12 18Z" fill="white"/>
                              <path d="M12 13C12 12.4 11.6 12 11 12C10.4 12 10 12.4 10 13V16C10 16.6 10.4 17 11 17C11.6 17 12 16.6 12 16V13Z" fill="white"/>
                            </svg>
                          {% elif message.attachment_type == 'doc' %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M16 13H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M16 17H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M10 9H9H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          {% endif %}
                        </div>
                        <div class="file-info">
                          <div class="file-name">{{ message.attachment_name }}</div>
                          <a href="{{ message.attachment.url }}" target="_blank" class="file-link">Download</a>
                        </div>
                      </div>
                    {% endif %}
                  {% endif %}
                {% endif %}
                <div class="message-time">
                  {{ message.sent_at|localtime|date:"g:i A" }}
                  {% if message.sender == request.user and not message.deleted_for_everyone %}
                  <div class="message-read-status" data-message-id="{{ message.id }}">
                    <span class="read-receipt" id="read-receipt-{{ message.id }}">
                      <span class="read-receipt-icon">&#10003;</span>
                    </span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="start-message" id="no-messages-prompt">No messages yet. Start the conversation!</div>
        {% endif %}
      {% else %}
        <!-- Start messaging prompt -->
        <div class="start-message">Add a friend to start messaging!</div>
        <button class="add-contact-button" onclick="openFriendDialog()">Add</button>
      {% endif %}
    </div>
    {% if active_chat %}
    <div class="input-area" style="display: flex; width: 100%;">
      <div class="chat-footer" style="width: 100%; display: flex;">
        <div class="input-container" style="width: 100%; display: flex; flex: 1;">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            class="message-input"
            style="flex: 1; width: calc(100% - 60px);"
            onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
          >
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachment(event)">
          <div class="input-buttons">
            <button class="location-button" onclick="sendLocation()">
              <span class="tooltip">Current Location</span>
              <i class="fa-solid fa-location-dot"></i>
            </button>
            <button class="attach-button" onclick="document.getElementById('fileInput').click()">
              <span class="tooltip">Add attachment</span>
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21.44 11.05L12.25 20.24C11.1242 21.3658 9.5972 21.9983 8.005 21.9983C6.4128 21.9983 4.88584 21.3658 3.76 20.24C2.63416 19.1142 2.00171 17.5872 2.00171 15.995C2.00171 14.4028 2.63416 12.8758 3.76 11.75L12.95 2.56C13.7006 1.80944 14.7186 1.38086 15.78 1.38086C16.8414 1.38086 17.8594 1.80944 18.61 2.56C19.3606 3.31056 19.7892 4.32856 19.7892 5.39C19.7892 6.45144 19.3606 7.46944 18.61 8.22L9.42 17.41C9.0348 17.7952 8.52577 18.0095 7.995 18.0095C7.46423 18.0095 6.95519 17.7952 6.57 17.41C6.18481 17.0248 5.97053 16.5158 5.97053 15.985C5.97053 15.4542 6.18481 14.9452 6.57 14.56L15.76 5.37"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button class="send-button" onclick="sendMessage()">
              <span class="tooltip">Send message</span>
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M22 2L11 13"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M22 2L15 22L11 13L2 9L22 2Z"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="attachment-preview" id="attachmentPreview">
      <button class="remove-attachment" onclick="removeAttachment()">&times;</button>
      <div class="file-info">
        <div class="file-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="file-name" id="attachmentName"></div>
        <div class="file-size" id="attachmentSize"></div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Dialog Box -->
  <div class="dialog-overlay" id="friendDialog" onclick="handleOverlayClick(event)">
    <div class="dialog-box">
      <div class="dialog-title">Add New Contact</div>
      {% csrf_token %}
      <div style="position: relative;">
        <input
          type="text"
          class="input-field"
          id="friendUsername"
          placeholder="Enter Username"
          onkeypress="if(event.key === 'Enter') searchFriend()"
        />
      </div>
      <div id="search-result"></div>
      <div class="dialog-buttons">
        <button class="dialog-button" onclick="searchFriend()">Search</button>
        <button class="dialog-button" onclick="closeFriendDialog()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add this after your existing modals -->
  <div id="notificationsModal" class="notifications-modal">
    <div class="notifications-content">
      <span class="notifications-close" onclick="closeNotificationsModal()">&times;</span>
      <div class="notifications-header">Notifications</div>
      <div id="notificationsContainer">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add user actions modal -->
  <div id="userActionsModal" class="user-actions-modal">
    <div class="user-actions-content">
      <div class="user-actions-header">
        <h2>Chat Actions</h2>
        <span class="close-modal" onclick="closeUserActionsModal()">&times;</span>
      </div>
      <div class="user-info-section">
        <div class="user-avatar">
          {% if active_chat %}
            {% if active_chat.sender == request.user %}
              {% if active_chat.recipient.profile_picture %}
                <img src="{{ active_chat.recipient.profile_picture.url }}" alt="Profile Picture">
              {% else %}
                <div class="avatar-initials">
                  {{ active_chat.recipient.first_name|slice:":1" }}{{ active_chat.recipient.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% else %}
              {% if active_chat.sender.profile_picture %}
                <img src="{{ active_chat.sender.profile_picture.url }}" alt="Profile Picture">
              {% else %}
                <div class="avatar-initials">
                  {{ active_chat.sender.first_name|slice:":1" }}{{ active_chat.sender.last_name|slice:":1" }}
                </div>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>
        <div class="user-details">
          <h3>
            {% if active_chat %}
              {% if active_chat.sender == request.user %}
                {{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}
              {% else %}
                {{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}
              {% endif %}
            {% endif %}
          </h3>
          <div class="user-username">
            {% if active_chat %}
              {% if active_chat.sender == request.user %}
                @{{ active_chat.recipient.username }}
              {% else %}
                @{{ active_chat.sender.username }}
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="user-actions">
        <button class="action-button archive" onclick="handleArchiveChat()">
          Archive Chat
        </button>
        <button class="action-button delete" onclick="handleDeleteChat()">
          Delete Chat
        </button>
        <button class="action-button block" onclick="handleBlockUser()">
          Block User
        </button>
      </div>
    </div>
  </div>

  <!-- Add group chat info modal -->
  <div id="groupChatInfoModal" class="user-actions-modal">
    <div class="user-actions-content">
      <div class="user-actions-header">
        <h2>Group Information</h2>
        <span class="close-modal" onclick="closeGroupChatInfoModal()">&times;</span>
      </div>
      <div class="group-info-section">
        <div class="group-avatar">
          <div class="avatar-initials" style="background-color: #3498db;">
            <i class="fa-solid fa-user-group" style="font-size: 24px;"></i>
          </div>
        </div>
        <div class="group-details">
          <h3 id="groupChatName">Group Name</h3>
          <div class="group-subtitle">
            <span id="groupMemberCount">0</span> members
          </div>
        </div>
      </div>
      <div class="group-members-section">
        <h4>Participants</h4>
        <div id="groupMembersList" class="group-members-list">
          <!-- Members will be loaded here -->
        </div>
      </div>
      <div class="user-actions">
        <button class="action-button archive" onclick="handleArchiveGroupChat()">
          Archive Chat
        </button>
        <button class="action-button delete" onclick="handleDeleteGroupChat()">
          Delete Chat
        </button>
        <button class="action-button exit" onclick="handleExitGroupChat()">
          Exit Group
        </button>
      </div>
    </div>
  </div>

  <!-- Add this right before the userActionsModal div -->
  <div id="modalBackdrop" class="modal-backdrop"></div>

  <!-- Add this at the end of the body or after your context menu div -->
  <div id="fullscreen-image-viewer" class="fullscreen-modal">
    <div class="fullscreen-modal-content">
      <span class="close-modal" onclick="closeImageViewer()">&times;</span>
      <img id="fullscreen-image" src="" alt="Fullscreen Image">
      <a id="download-image-btn" href="" download class="download-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download
      </a>
    </div>
  </div>

  <!-- Add archived chats modal after other modals -->
  <div id="archivedChatsModal" class="user-actions-modal">
    <div class="user-actions-content">
      <div class="user-actions-header">
        <h2>Archived Chats</h2>
        <span class="close-modal" onclick="closeArchivedChatsModal()">&times;</span>
      </div>
      <div id="archivedChatsContainer" style="
          min-height: 100px;
          padding: 10px;
      ">
        <div class="loading-spinner-container">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add the missing delete confirmation modal -->
  <div id="deleteConfirmationModal" class="user-actions-modal">
    <div class="user-actions-content">
      <div class="user-actions-header">
        <h2>Delete Confirmation</h2>
        <span class="close-modal" onclick="closeDeleteConfirmation()">&times;</span>
      </div>
      <div style="padding: 20px; text-align: center;">
        <p style="margin-bottom: 20px; color: #ff6b6b;">Are you sure you want to delete this chat?</p>
        <p style="margin-bottom: 20px; color: #aaa; font-size: 14px;">This action cannot be undone.</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
          <button onclick="closeDeleteConfirmation()" style="padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
          <button onclick="confirmDeleteChat()" style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add the missing block confirmation modal -->
  <div id="blockConfirmationModal" class="block-confirmation-modal">
    <div class="block-confirmation-content">
      <h3>Block User?</h3>
      <p>
        Blocking this user will prevent them from sending you messages.
        You will not see any messages from them, and they won't be able to see when you're online.
      </p>
      <div class="block-confirmation-buttons">
        <button class="cancel" onclick="closeBlockConfirmation()">Cancel</button>
        <button class="confirm" onclick="confirmBlockUser()">Block</button>
      </div>
    </div>
  </div>

  <!-- Add the report confirmation modal after other modals -->
  <div id="reportConfirmationModal" class="user-actions-modal">
    <div class="user-actions-content">
      <span class="close-modal" onclick="closeReportConfirmation()">&times;</span>
      <h3 style="color: #ff4d4d; margin-bottom: 20px;">Report Message</h3>
      
      <div style="margin-bottom: 20px; background-color: #2a2a2a; border-radius: 8px; padding: 15px;">
        <p style="margin-bottom: 10px; color: #888;">Message content:</p>
        <p id="reportMessageContent" style="font-style: italic; word-break: break-word;"></p>
      </div>
      
      <p style="margin-bottom: 20px; color: #ddd; line-height: 1.5;">
        Are you sure you want to report this message? This will send a notification to our moderation team for review.
      </p>
      
      <div style="display: flex; justify-content: space-between; gap: 10px;">
        <button onclick="closeReportConfirmation()" style="flex: 1; padding: 10px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Cancel
        </button>
        <button id="confirmReportBtn" style="flex: 1; padding: 10px; background-color: #ff4d4d; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Report Message
        </button>
      </div>
    </div>
  </div>

  <script>
    // Set authentication status for use in JavaScript
    const isUserAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
    
    // Use the same function names as in base.html for consistency
    function openFriendDialog() {
      document.getElementById("friendDialog").style.display = "flex";
      // Clear previous search results and input when opening
      document.getElementById("search-result").innerHTML = "";
      document.getElementById("friendUsername").value = "";
      // Focus the input field
      setTimeout(() => {
        document.getElementById("friendUsername").focus();
      }, 100);
    }
    
    // Single function to handle both navbar and chat "Add" buttons
    function openDialog() {
      openFriendDialog(); // Use the shared function
    }

    function closeFriendDialog() {
      document.getElementById("friendDialog").style.display = "none";
    }
    
    // Legacy function for backward compatibility
    function closeDialog() {
      closeFriendDialog();
    }

    function handleOverlayClick(event) {
      // Close dialog only if clicking the overlay itself, not its children
      if (event.target.id === 'friendDialog') {
        closeFriendDialog();
      }
    }

    function searchUser() {
      const username = document.getElementById("friendUsername").value;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const searchResult = document.getElementById("search-result");
      
      if (!username.trim()) {
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">Please enter a username</div>';
        return;
      }
      
      console.log("Searching for user:", username);
      searchResult.innerHTML = '<div class="search-result-item">Searching...</div>';

      fetch("/search_user/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
        }),
      })
      .then(response => response.json())
      .then((data) => {
        console.log("Search response data:", data);
        if (data.status === "success") {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'search-result-item';
          resultDiv.textContent = `${data.first_name} ${data.last_name}`;
          resultDiv.addEventListener('click', function() {
            console.log('Search result clicked');
            startChat(data.username);
          });
          
          searchResult.innerHTML = '';
          searchResult.appendChild(resultDiv);
        } else {
          searchResult.innerHTML = `<div class="search-result-item" style="color: #ff6b6b;">${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error('Error in searchUser:', error);
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">An error occurred. Please try again.</div>';
      });
    }

    function startChat(username) {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      console.log("Starting chat with:", username);
      console.log("Using CSRF token:", csrfToken);

      fetch("/start_chat/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
        }),
      })
      .then(response => {
        console.log("Start chat response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Start chat response data:", data);
        if (data.status === 'success') {
          // Close the dialog
          closeDialog();
          
          // Create new chat item if it doesn't exist
          if (!document.querySelector(`[data-chat-url="/chats/${data.chat_id}/"]`)) {
            console.log("Creating new chat item in the list");
            const chatList = document.querySelector('.chat-list');
            const noChatsMessage = chatList.querySelector('div[style*="text-align: center"]');
            if (noChatsMessage) {
              noChatsMessage.remove();
            }

            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-url', `/chats/${data.chat_id}/`);
            chatItem.onclick = () => window.location.href = `/chats/${data.chat_id}/`;

            const initials = `${data.recipient.first_name[0]}${data.recipient.last_name[0]}`;
            
            chatItem.innerHTML = `
              <div class="chat-item-pfp">
                ${data.recipient.profile_picture 
                  ? `<img src="${data.recipient.profile_picture}" alt="Profile Picture" class="pfp-image" style="display: block;">` 
                  : `<div class="pfp-initials">${initials}</div>`}
              </div>
              <div class="chat-item-details">
                <div class="chat-item-name"
                     data-first-name="${data.recipient.first_name}"
                     data-last-name="${data.recipient.last_name}">
                  ${data.recipient.first_name} ${data.recipient.last_name}
                </div>
                <div class="chat-item-preview">
                  No messages yet
                </div>
              </div>
              <div style="font-size: 12px; color: #666; text-align: right">
                Just now
              </div>
            `;

            // Add the new chat item at the top of the list
            chatList.insertBefore(chatItem, chatList.firstChild);
            console.log("New chat item added to the list");
          } else {
            console.log("Chat item already exists in the list");
          }
          
          // Redirect to the chat
          console.log("Redirecting to chat:", `/chats/${data.chat_id}/`);
          window.location.href = `/chats/${data.chat_id}/`;
        } else {
          // Show error message
          console.error("Error starting chat:", data.message);
          document.getElementById("search-result").innerHTML = 
            `<div class="search-result-item" style="color: #ff6b6b;">${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error('Error in startChat:', error);
        document.getElementById("search-result").innerHTML = 
          '<div class="search-result-item" style="color: #ff6b6b;">An error occurred. Please try again.</div>';
      });
    }

    // Handle profile pictures and initials
    document.querySelectorAll(".chat-item").forEach((chatItem) => {
      const pfpImage = chatItem.querySelector(".pfp-image");
      const pfpInitials = chatItem.querySelector(".pfp-initials");

      if (pfpImage) {
        // Set initial display to block
        pfpImage.style.display = "block";
        
        // Add error handler for the image
        pfpImage.onerror = function() {
          console.log("Profile picture failed to load, showing initials");
          this.style.display = "none";
          if (pfpInitials) {
            pfpInitials.style.display = "flex";
          }
        };
        
        // Add load handler for the image
        pfpImage.onload = function() {
          console.log("Profile picture loaded successfully");
          this.style.display = "block";
          if (pfpInitials) {
            pfpInitials.style.display = "none";
          }
        };
      }
    });

    // Function to initialize the chat interface
    function initializeChatInterface() {
      // Handle focus for the message input
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.focus();
      }
      
      // Set up event listeners for the attachment preview
      setupAttachmentPreviewListeners();
      
      // Make sure input area is visible
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      if (activeChatId && inputArea) {
        inputArea.style.display = 'flex';
      }
    }

    // Function to handle image viewer
    function openImageViewer(imageUrl) {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const fullscreenImage = document.getElementById('fullscreen-image');
      const downloadBtn = document.getElementById('download-image-btn');
      const navbar = document.querySelector('.navbar');
      
      fullscreenImage.src = imageUrl;
      
      // Set up download button
      if (downloadBtn) {
        downloadBtn.href = imageUrl;
        // Extract filename from URL to use as download name
        const fileName = imageUrl.split('/').pop();
        downloadBtn.setAttribute('download', fileName);
      }
      
      // Slide navbar up
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(-100%)';
      }
      
      // Show the viewer with transition
      viewer.style.display = 'block';
      // Trigger reflow to ensure the transition works
      viewer.offsetHeight;
      viewer.classList.add('visible');
      
      // Prevent scrolling on the body when modal is open
      document.body.style.overflow = 'hidden';
    }

    function closeImageViewer() {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const navbar = document.querySelector('.navbar');
      
      // Slide navbar down
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(0)';
      }
      
      // Hide the viewer with transition
      viewer.classList.remove('visible');
      
      // Wait for the transition to complete before hiding
      setTimeout(() => {
        viewer.style.display = 'none';
      }, 300); // Match the transition duration (0.3s)
      
      // Re-enable scrolling on the body
      document.body.style.overflow = 'auto';
    }

    // Setup attachment preview listeners function
    function setupAttachmentPreviewListeners() {
      const fileInput = document.getElementById('fileInput');
      const attachmentPreview = document.getElementById('attachmentPreview');
      
      if (fileInput && attachmentPreview) {
        // File input change handler
        fileInput.addEventListener('change', function(event) {
          handleAttachment(event);
        });
      }
    }

    // Function to set up click listeners for image attachments
    function setupImageAttachmentListeners() {
      const imageAttachments = document.querySelectorAll('.message-attachment img');
      imageAttachments.forEach(img => {
        img.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openImageViewer(this.src);
        });
      });
    }

    // Mark all messages in the current chat as read when it's viewed
    function markMessagesAsRead() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) return;
      
      fetch(`/mark_messages_read/${activeChatId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          console.log(`Marked ${data.count} messages as read`);
        }
      })
      .catch(error => {
        console.error('Error marking messages as read:', error);
      });
    }

    // Function to check read receipts for sent messages
    function checkReadReceipts() {
      // Get all sent messages in the active chat
      const sentMessages = document.querySelectorAll('.message-sent');
      if (!sentMessages.length) return;
      
      // Check read status for each sent message
      sentMessages.forEach(message => {
        const messageId = message.dataset.messageId;
        if (!messageId) return;
        
        fetch(`/check_message_status/${messageId}/`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const readReceipt = document.getElementById(`read-receipt-${messageId}`);
            if (readReceipt) {
              if (data.is_read) {
                // Message is read - blue tick
                readReceipt.classList.add('read');
              } else {
                // Message is delivered but not read - grey tick
                readReceipt.classList.remove('read');
              }
            }
          }
        })
        .catch(error => {
          console.error(`Error checking read status for message ${messageId}:`, error);
        });
      });
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Scroll messages container to bottom when loading chat
    document.addEventListener("DOMContentLoaded", function() {
      const messagesContainer = document.querySelector(".messages-container");
      if (messagesContainer) {
        // Force a reflow to ensure scrollHeight is calculated correctly
        setTimeout(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
      }

      // Initialize input area if there's an active chat
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      if (activeChatId && inputArea) {
        inputArea.style.display = 'block';
      }
    });

    // Also scroll to bottom when messages are loaded or when switching chats
    function scrollToBottom() {
      const messagesContainer = document.querySelector(".messages-container");
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // Call scrollToBottom when the page loads
    window.onload = function() {
      scrollToBottom();
      
      // Ensure input area is visible if there's an active chat
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      if (activeChatId && inputArea) {
        inputArea.style.display = 'block';
      }
    };

    // Ensure images are loaded before scrolling
    document.querySelectorAll('.messages-container img').forEach(img => {
      img.onload = scrollToBottom;
    });

    // Add these new functions to your existing script
    let selectedMessageElement = null;

    function showContextMenu(event, messageElement) {
      // Hide any existing context menu first
      hideContextMenu();
      
      event.preventDefault(); // Prevent default context menu
      event.stopPropagation(); // Stop event from bubbling up
      
      const contextMenu = document.getElementById('message-context-menu');
      if (!contextMenu) {
        return;
      }
      
      const messageId = messageElement.dataset.messageId;
      const senderId = messageElement.dataset.senderId;
      const isGroupMessage = messageElement.dataset.isGroup === 'true';
      const currentUserId = "{{ request.user.id }}";
      
      if (!messageId) {
        return;
      }

      // Get the profile picture and name from the message
      const messagePfp = messageElement.querySelector('.message-pfp');
      const contextMenuPfp = document.getElementById('contextMenuPfp');
      const contextMenuName = document.getElementById('contextMenuName');

      // Copy the profile picture content
      if (messagePfp) {
        contextMenuPfp.innerHTML = messagePfp.innerHTML;
      }

      // Set the sender's name based on message type (group or individual)
      if (isGroupMessage) {
        // For group messages
        if (senderId === currentUserId) {
          contextMenuName.textContent = "{{ request.user.first_name }} {{ request.user.last_name }}";
        } else {
          const senderName = messageElement.dataset.senderName || 'Unknown User';
          contextMenuName.textContent = senderName;
        }
      } else {
        // For individual chat messages
        {% if active_chat %}
          if (senderId === currentUserId) {
            contextMenuName.textContent = "{{ request.user.first_name }} {{ request.user.last_name }}";
          } else {
            contextMenuName.textContent = "{% if active_chat.sender == request.user %}{{ active_chat.recipient.first_name }} {{ active_chat.recipient.last_name }}{% else %}{{ active_chat.sender.first_name }} {{ active_chat.sender.last_name }}{% endif %}";
          }
        {% endif %}
      }
      
      // Show/hide "Delete for everyone" option based on whether user is the sender
      const deleteForEveryoneOption = contextMenu.querySelector('.sender-only');
      if (deleteForEveryoneOption) {
        deleteForEveryoneOption.style.display = senderId === currentUserId ? 'block' : 'none';
      }
      
      // Update the message ID and content in all context menu items
      contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
        item.dataset.messageId = messageId;
        item.dataset.messageContent = messageElement.querySelector('.message-content').textContent.trim();
        item.dataset.isGroup = isGroupMessage ? 'true' : 'false';
      });
      
      // Position the context menu at the mouse position
      contextMenu.style.display = 'block';
      
      // Calculate position relative to viewport
      const x = event.clientX;
      const y = event.clientY;
      
      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Get menu dimensions
      const menuWidth = contextMenu.offsetWidth;
      const menuHeight = contextMenu.offsetHeight;
      
      // Check if menu goes outside viewport
      const rightEdgeExceeded = x + menuWidth > viewportWidth;
      const bottomEdgeExceeded = y + menuHeight > viewportHeight;
      
      // Position menu
      contextMenu.style.left = rightEdgeExceeded ? `${x - menuWidth}px` : `${x}px`;
      contextMenu.style.top = bottomEdgeExceeded ? `${y - menuHeight}px` : `${y}px`;
    }

    function pinMessage(menuItem) {
      const messageId = menuItem.dataset.messageId;
      if (!messageId) return;
      
      // Find the message element
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageElement) return;
      
      // Get message content
      const messageContent = messageElement.querySelector('.message-content').textContent.trim();
      
      // Save the pinned message info in sessionStorage
      const pinnedMessageInfo = {
        messageId: messageId,
        content: messageContent
      };
      sessionStorage.setItem('pinnedMessage', JSON.stringify(pinnedMessageInfo));
      
      // Update the pinned message container
      const pinnedMessageContent = document.getElementById('pinnedMessageContent');
      const pinnedMessageContainer = document.getElementById('pinnedMessageContainer');
      
      pinnedMessageContent.textContent = messageContent;
      pinnedMessageContent.dataset.messageId = messageId;
      pinnedMessageContainer.classList.add('active');
      
      // Show success notification
      const notification = document.createElement('div');
      notification.style.position = 'fixed';
      notification.style.bottom = '20px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = '#3498db';
      notification.style.color = 'white';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.zIndex = '10000';
      notification.textContent = 'Message pinned!';
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 2000);
      hideContextMenu();
    }
    
    function unpinMessage(event) {
      event.stopPropagation(); // Prevent the container click from firing
      
      // Remove the pinned message from sessionStorage
      sessionStorage.removeItem('pinnedMessage');
      
      // Hide the pinned message container
      const pinnedMessageContainer = document.getElementById('pinnedMessageContainer');
      pinnedMessageContainer.classList.remove('active');
      
      // Show feedback notification
      const notification = document.createElement('div');
      notification.style.position = 'fixed';
      notification.style.bottom = '20px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = '#666';
      notification.style.color = 'white';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.zIndex = '10000';
      notification.textContent = 'Message unpinned';
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 2000);
    }

    function copyMessage(menuItem) {
      const messageContent = menuItem.dataset.messageContent;
      if (messageContent) {
        navigator.clipboard.writeText(messageContent)
          .then(() => {
            // Show a brief notification that the message was copied
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#333';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '10000';
            notification.textContent = 'Message copied!';
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 2000);
          })
          .catch(err => console.error('Failed to copy message:', err));
      }
      hideContextMenu();
    }

    function hideContextMenu() {
      const contextMenu = document.getElementById('message-context-menu');
      if (contextMenu) {
        contextMenu.style.display = 'none';
      }
    }

    // Close context menu when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('#message-context-menu')) {
        hideContextMenu();
      }
    });

    // Close context menu when scrolling
    const messagesContainer = document.querySelector('.messages-container');
    if (messagesContainer) {
      messagesContainer.addEventListener('scroll', hideContextMenu);
    }

    // Close context menu when pressing Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        hideContextMenu();
      }
    });

    // Close context menu when window is resized
    window.addEventListener('resize', hideContextMenu);

    // Prevent context menu from appearing on right-click outside messages
    document.addEventListener('contextmenu', function(event) {
      if (!event.target.closest('.message')) {
        event.preventDefault();
        hideContextMenu();
      }
    });

    function deleteMessageForMe(menuItem) {
      const messageId = menuItem.dataset.messageId;
      const isGroup = menuItem.dataset.isGroup === 'true';
      
      if (!messageId) return;
      
      // Different endpoint for group vs individual chat
      const endpoint = isGroup ? '/delete_group_message_for_me/' : '/delete_message_for_me/';
      const dataKey = isGroup ? 'message_id' : 'message_id';
      
      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ [dataKey]: messageId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Hide the message in the UI
          const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
          if (messageElement) {
            messageElement.style.display = 'none';
          }
        } else {
          // Show error notification
          showToast(data.message || 'Failed to delete message', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting message', 'error');
      });
      
      hideContextMenu();
    }

    function deleteMessageForEveryone(menuItem) {
      const messageId = menuItem.dataset.messageId;
      const isGroup = menuItem.dataset.isGroup === 'true';
      
      if (!messageId) return;
      
      // Different endpoint for group vs individual chat
      const endpoint = isGroup ? '/delete_group_message_for_everyone/' : '/delete_message_for_everyone/';
      const dataKey = isGroup ? 'message_id' : 'message_id';
      
      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ [dataKey]: messageId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Replace the message content with a deleted message indicator
          const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
          if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            if (contentElement) {
              contentElement.innerHTML = '<i style="color: #888;">This message was deleted</i>';
            }
          }
        } else {
          // Show error notification
          showToast(data.message || 'Failed to delete message for everyone', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting message for everyone', 'error');
      });
      
      hideContextMenu();
    }

    function reportMessage(menuItem) {
      const messageId = menuItem.dataset.messageId;
      const messageContent = menuItem.dataset.messageContent;
      const isGroup = menuItem.dataset.isGroup === 'true';
      
      if (!messageId) return;
      
      // Show the custom modal instead of the browser confirm
      const modal = document.getElementById('reportConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      const reportMessageContent = document.getElementById('reportMessageContent');
      const confirmReportBtn = document.getElementById('confirmReportBtn');
      
      // Set the message content in the modal
      reportMessageContent.textContent = messageContent;
      
      // Show the modal and backdrop
      if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        
        // Update the confirm button click handler
        confirmReportBtn.onclick = function() {
          // Different endpoint for group vs individual chat
          const endpoint = isGroup ? '/report_group_message/' : '/report_message/';
          const dataKey = isGroup ? 'message_id' : 'message_id';
          
          fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ [dataKey]: messageId })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              showToast('Message reported successfully', 'success');
            } else {
              showToast(data.message || 'Failed to report message', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error reporting message', 'error');
          });
          
          // Close the modal
          closeReportConfirmation();
        };
      }
      
      hideContextMenu();
    }

    function closeReportConfirmation() {
      const modal = document.getElementById('reportConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      if (modal && backdrop) {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
      }
    }

    // Add these functions to your existing script
    function checkNotifications() {
      console.log('Checking notifications...');
      fetch('/check_notifications/', {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => {
        console.log('Notification check response:', response);
        return response.json();
      })
      .then(data => {
        console.log('Notification data:', data);
        const hasUnread = data.notifications && data.notifications.length > 0;
        const indicator = document.getElementById('notificationIndicator');
        if (indicator) {
          indicator.style.display = hasUnread ? 'block' : 'none';
        }
      })
      .catch(error => {
        console.error('Error checking notifications:', error);
      });
    }

    function loadNotifications() {
      console.log('Loading notifications...');
      const container = document.getElementById('notificationsContainer');
      
      if (!container) {
        console.error('Notifications container not found');
        return;
      }
      
      container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';

      fetch('/check_notifications/', {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('Loaded notification data:', data);
        if (!data.notifications || data.notifications.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #888;">No notifications</div>';
          return;
        }

        container.innerHTML = data.notifications.map(notification => `
          <div class="notification-item ${notification.type} ${notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 'broadcast' : ''}">
            <div class="notification-type" style="color: ${notification.type === 'warning' ? '#ffa500' : '#3498db'}">
              ${notification.type === 'warning' ? 'WARNING' : 
                notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 'ADMIN BROADCAST' : 'INFORMATION'}
            </div>
            <div class="notification-message" style="
              ${notification.admin_notes && notification.admin_notes.includes('Broadcast') ? 
                'font-size: 1.1em; color: #fff; margin: 15px 0;' : ''}">
              ${notification.message}
            </div>
            ${notification.admin_notes ? `
              <div class="notification-admin-notes" style="
                color: ${notification.admin_notes.includes('Broadcast') ? '#ffd700' : '#888'};
                font-style: ${notification.admin_notes.includes('Broadcast') ? 'italic' : 'normal'};
              ">
                ${notification.admin_notes.includes('Broadcast') ? 
                  notification.admin_notes : `Admin notes: ${notification.admin_notes}`}
              </div>
            ` : ''}
            <div class="notification-time">
              ${new Date(notification.created_at).toLocaleString()}
            </div>
          </div>
        `).join('');

        // Mark notifications as read
        return fetch('/mark_notifications_read/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
      })
      .then(() => {
        // Hide the notification indicator
        const indicator = document.getElementById('notificationIndicator');
        if (indicator) {
          indicator.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Error loading notifications:', error);
        container.innerHTML = '<div style="text-align: center; color: #ff6b6b;">Error loading notifications</div>';
      });
    }

    function openNotificationsModal() {
      console.log('Opening notifications modal...');
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.style.display = 'flex';
        loadNotifications();
      }
    }

    function closeNotificationsModal() {
      console.log('Closing notifications modal...');
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Set up notification event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up notification event listeners...');
      
      // Set up notification bell click handler
      const notificationBell = document.getElementById('notificationBell');
      if (notificationBell) {
        notificationBell.addEventListener('click', function(e) {
          console.log('Notification bell clicked');
          e.preventDefault();
          e.stopPropagation();
          openNotificationsModal();
        });
      }

      // Set up modal click-outside-to-close
      const modal = document.getElementById('notificationsModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeNotificationsModal();
          }
        });
      }

      // Initial notifications check
      checkNotifications();
      
      // Set up periodic notifications check
      setInterval(checkNotifications, 30000); // Check every 30 seconds
    });

    // Add this new function to handle chat loading
    function loadChat(chatItem, event) {
      // Prevent default if it's an anchor tag
      if (event) {
        event.preventDefault();
      }
      
      // Get the chat URL and ID
      const chatUrl = chatItem.dataset.chatUrl;
      const chatId = chatItem.dataset.chatId;
      
      // Set the chat as active
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      chatItem.classList.add('active');
      
      // Remove unread indicator
      chatItem.classList.remove('has-unread');
      const unreadIndicator = chatItem.querySelector('.unread-indicator');
      if (unreadIndicator) {
        unreadIndicator.style.display = 'none';
      }
      
      // Ensure the input area is visible right away
      const inputArea = document.querySelector('.input-area');
      if (inputArea) {
        inputArea.style.display = 'flex';
        console.log('Setting input area display to flex for chat', chatId);
      }
      
      // Show loading spinner in the messages container
      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.innerHTML = '<div class="loading-spinner-container"><div class="loading-spinner"></div></div>';
      
      // Fetch the chat details with AJAX
      fetch(chatUrl)
        .then(response => response.text())
        .then(html => {
          // Extract just the messages container content from the response
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newMessages = doc.querySelector('.messages-container').innerHTML;
          
          // Update the messages container
          messagesContainer.innerHTML = newMessages;
          
          // Safely call these functions if they exist
          if (typeof setupImageAttachmentListeners === 'function') {
            setupImageAttachmentListeners();
          }
          
          if (typeof markMessagesAsRead === 'function') {
            markMessagesAsRead();
          }
          
          if (typeof checkReadReceipts === 'function') {
            checkReadReceipts();
          }
          
          // Update the URL without refreshing the page
          history.pushState({}, '', chatUrl);
          
          // Scroll to the bottom
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // Update the chat header, preserving all data attributes
          const chatHeader = document.querySelector('.chat-header');
          const newChatHeader = doc.querySelector('.chat-header');
          if (chatHeader && newChatHeader) {
            chatHeader.innerHTML = newChatHeader.innerHTML;
          }
          
          // Ensure input area is visible again (double-check)
          if (inputArea) {
            inputArea.style.display = 'flex';
          }
        })
        .catch(error => {
          console.error('Error loading chat:', error);
          messagesContainer.innerHTML = '<div class="error-message">Error loading chat. Please try again.</div>';
        });
    }

    // Remove the chat context menu related functions and add these new functions
    function openUserActionsModal() {
      // Get the current active chat information
      const activeChatId = window.location.pathname.split('/').filter(part => part).pop();
      const modal = document.getElementById('userActionsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      // Check if this is a group chat, if so, open the group chat modal instead
      const chatHeader = document.querySelector('.chat-header-info');
      if (chatHeader && chatHeader.dataset.isGroup === 'true') {
        openGroupChatInfoModal();
        return;
      }
      
      // Get the current recipient's information from the chat header
      const chatHeaderName = document.querySelector('.chat-header-name').textContent.trim();
      
      // Update modal content with current chat user info
      const userAvatar = modal.querySelector('.user-avatar');
      const userNameElement = modal.querySelector('.user-details h3');
      const userUsernameElement = modal.querySelector('.user-username');
      
      // Set the user name
      if (userNameElement) {
        userNameElement.textContent = chatHeaderName;
      }
      
      // For username, we'll need to get it from the data attributes we'll add
      if (chatHeader && chatHeader.dataset.username) {
        userUsernameElement.textContent = '@' + chatHeader.dataset.username;
      }
      
      // For avatar, either use the image or initials based on chat header data
      if (chatHeader && chatHeader.dataset.hasProfilePicture === 'true') {
        // Use image
        userAvatar.innerHTML = `<img src="${chatHeader.dataset.profilePicture}" alt="Profile Picture">`;
      } else {
        // Use initials
        const nameParts = chatHeaderName.split(' ');
        const initials = nameParts.length >= 2 ? 
          `${nameParts[0].charAt(0)}${nameParts[1].charAt(0)}` : 
          chatHeaderName.substring(0, 2);
        
        userAvatar.innerHTML = `<div class="avatar-initials">${initials}</div>`;
      }
      
      // Show the modal
      modal.style.display = 'block';
      backdrop.style.display = 'block';
      
      // Close modal when clicking outside
      backdrop.onclick = function() {
        closeUserActionsModal();
      };
    }
    
    function openGroupChatInfoModal() {
      // Get the current group chat information
      const chatHeader = document.querySelector('.chat-header-info');
      if (!chatHeader || chatHeader.dataset.isGroup !== 'true') {
        return;
      }
      
      const groupId = chatHeader.dataset.groupId;
      if (!groupId) {
        console.error('No group ID found');
        return;
      }
      
      const modal = document.getElementById('groupChatInfoModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      // Show loading state
      const membersList = document.getElementById('groupMembersList');
      if (membersList) {
        membersList.innerHTML = '<div style="text-align: center; padding: 10px; color: #888;">Loading members...</div>';
      }
      
      // Get the group name from the header
      const groupNameElement = document.querySelector('.chat-header-name');
      const groupName = groupNameElement ? groupNameElement.textContent.split('(')[0].trim() : 'Group Chat';
      
      // Update the group name in the modal
      const modalGroupName = document.getElementById('groupChatName');
      if (modalGroupName) {
        modalGroupName.textContent = groupName;
      }
      
      // Fetch group data from server
      fetch(`/group/${groupId}/messages/`, {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status !== 'success') {
          showToast('Failed to load group information. Please try again.', 'error');
          return;
        }
        
        // Update group member count
        const memberCount = document.getElementById('groupMemberCount');
        if (memberCount) {
          memberCount.textContent = data.participants.length;
        }
        
        // Update participants list
        if (membersList) {
          membersList.innerHTML = '';
          
          data.participants.forEach(participant => {
            const memberElement = document.createElement('div');
            memberElement.className = 'group-member';
            
            const nameInitials = participant.name.split(' ').map(part => part[0]).join('').slice(0, 2);
            
            memberElement.innerHTML = `
              <div class="member-avatar">
                <div class="member-initials">${nameInitials}</div>
              </div>
              <div class="member-details">
                <div class="member-name">
                  ${participant.name}
                  ${participant.is_you ? '<span class="member-role">You</span>' : ''}
                </div>
                <div class="member-username">@${participant.username}</div>
              </div>
            `;
            
            membersList.appendChild(memberElement);
          });
        }
        
        // Show the modal
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        
        // Close modal when clicking outside
        backdrop.onclick = function() {
          closeGroupChatInfoModal();
        };
      })
      .catch(error => {
        console.error('Error loading group info:', error);
        showToast('Failed to load group information. Please try again.', 'error');
      });
    }
    
    function closeGroupChatInfoModal() {
      const modal = document.getElementById('groupChatInfoModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'none';
      backdrop.style.display = 'none';
    }
    
    function handleArchiveGroupChat() {
      // Get the current group chat ID from the header
      const chatHeader = document.querySelector('.chat-header-info');
      if (!chatHeader || chatHeader.dataset.isGroup !== 'true') {
        showToast('No active group chat found', 'error');
        return;
      }
      
      const groupId = chatHeader.dataset.groupId;
      if (!groupId) {
        showToast('Group ID not found', 'error');
        return;
      }
      
      // Show loading indicator
      showToast('Archiving group chat...', 'info');
      
      // Send request to archive the group chat
      fetch('/archive_group_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ group_id: groupId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Close the modal
          closeGroupChatInfoModal();
          
          // Remove the chat from the list
          const chatItem = document.querySelector(`.chat-item[data-group-id="${groupId}"]`);
          if (chatItem) {
            chatItem.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close the user actions modal
          closeUserActionsModal();
          
          // Show success message
          showToast('Group chat archived successfully');
        } else {
          showToast(data.message || 'Failed to archive group chat', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to archive group chat. Please try again.', 'error');
      });
    }
    
    function handleDeleteGroupChat() {
      // Get the current group chat ID from the header
      const chatHeader = document.querySelector('.chat-header-info');
      if (!chatHeader || chatHeader.dataset.isGroup !== 'true') {
        showToast('No active group chat found', 'error');
        return;
      }
      
      const groupId = chatHeader.dataset.groupId;
      if (!groupId) {
        showToast('Group ID not found', 'error');
        return;
      }
      
      // Show confirmation first
      if (!confirm('Are you sure you want to delete this group chat? This will delete the group for all members and cannot be undone.')) {
        return;
      }
      
      // Show loading indicator
      showToast('Deleting group chat...', 'info');
      
      // Send request to delete the group chat
      fetch('/delete_group_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ group_id: groupId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Close the modal
          closeGroupChatInfoModal();
          
          // Remove the chat from the list
          const chatItem = document.querySelector(`.chat-item[data-group-id="${groupId}"]`);
          if (chatItem) {
            chatItem.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          showToast('Group chat deleted successfully');
        } else {
          showToast(data.message || 'Failed to delete group chat', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to delete group chat. Please try again.', 'error');
      });
    }
    
    function handleExitGroupChat() {
      // Get the current group chat ID from the header
      const chatHeader = document.querySelector('.chat-header-info');
      if (!chatHeader || chatHeader.dataset.isGroup !== 'true') {
        showToast('No active group chat found', 'error');
        return;
      }
      
      const groupId = chatHeader.dataset.groupId;
      if (!groupId) {
        showToast('Group ID not found', 'error');
        return;
      }
      
      // Show confirmation dialog
      if (!confirm('Are you sure you want to leave this group chat?')) {
        return;
      }
      
      // Show loading indicator
      showToast('Leaving group chat...', 'info');
      
      // Send request to exit the group chat
      fetch('/exit_group_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ group_id: groupId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Close the modal
          closeGroupChatInfoModal();
          
          // Remove the chat from the list
          const chatItem = document.querySelector(`.chat-item[data-group-id="${groupId}"]`);
          if (chatItem) {
            chatItem.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          showToast(data.message || 'You have left the group chat');
        } else {
          showToast(data.message || 'Failed to leave group chat', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to leave group chat. Please try again.', 'error');
      });
    }

    function closeUserActionsModal() {
      const modal = document.getElementById('userActionsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'none';
      backdrop.style.display = 'none';
    }

    function handleDeleteChat() {
      const modal = document.getElementById('deleteConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'block';
      backdrop.style.display = 'block';
    }

    function closeDeleteConfirmation() {
      const modal = document.getElementById('deleteConfirmationModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      modal.style.display = 'none';
      backdrop.style.display = 'none';
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast-message ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Trigger reflow
      toast.offsetHeight;
      
      // Show toast
      toast.classList.add('show');
      
      // Hide and remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 3000);
      }, 3000);
    }

    function confirmDeleteChat() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) {
        showToast('No active chat found', 'error');
        return;
      }

      fetch('/delete_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: activeChatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove the chat item from the list
          const chatElement = document.querySelector(`[data-chat-id="${activeChatId}"]`);
          if (chatElement) {
            chatElement.remove();
          }
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close both modals
          closeDeleteConfirmation();
          closeUserActionsModal();
          
          showToast('Chat deleted successfully');
        } else {
          showToast('Failed to delete chat. Please try again.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to delete chat. Please try again.', 'error');
      });
    }

    // Close delete confirmation modal when clicking outside
    document.getElementById('modalBackdrop').addEventListener('click', function() {
      closeDeleteConfirmation();
      closeUserActionsModal();
      closeGroupChatInfoModal();
    });

    // Close delete confirmation modal when pressing Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeDeleteConfirmation();
        closeUserActionsModal();
        closeGroupChatInfoModal();
      }
    });

    // Block User Modal Functions
    function showBlockConfirmation() {
      document.getElementById('blockConfirmationModal').style.display = 'flex';
    }

    function closeBlockConfirmation() {
      document.getElementById('blockConfirmationModal').style.display = 'none';
    }

    function handleBlockUser() {
      showBlockConfirmation();
      }

    function confirmBlockUser() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) {
        showToast('No active chat found', 'error');
        return;
      }

      fetch('/block_user/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: activeChatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove the chat from the list
          const chatItem = document.querySelector(`[data-chat-id="${activeChatId}"]`);
          if (chatItem) {
            chatItem.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close both modals
          closeBlockConfirmation();
          closeUserActionsModal();
          
          // Show success message
          showToast('User blocked successfully', 'success');
        } else {
          showToast(data.message || 'Failed to block user', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Failed to block user', 'error');
      });
    }

    // Add this new function to check if a user is blocked
    function checkIfUserIsBlocked(chatId) {
      return fetch('/check_if_user_is_blocked/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: chatId })
      })
      .then(response => response.json())
      .then(data => {
        return data.is_blocked;
      })
      .catch(error => {
        console.error('Error checking block status:', error);
        return false;
      });
    }

    // Add these new functions for attachment handling
    let selectedFile = null;

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const preview = document.getElementById('attachmentPreview');
        const fileName = document.getElementById('attachmentName');
        const fileSize = document.getElementById('attachmentSize');
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML = `
              <button class="remove-attachment" onclick="removeAttachment()">&times;</button>
              <img src="${e.target.result}" alt="Preview">
              <div class="file-info">
                <div class="file-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 16L8.586 11.414C9.367 10.633 10.633 10.633 11.414 11.414L16 16M14 14L15.586 12.414C16.367 11.633 17.633 11.633 18.414 12.414L20 14M6 20H18C19.105 20 20 19.105 20 18V6C20 4.895 19.105 4 18 4H6C4.895 4 4 4.895 4 6V18C4 19.105 4.895 20 6 20Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
            `;
          };
          reader.readAsDataURL(file);
        }
        
        preview.classList.add('show');
      }
    });

    function removeAttachment() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('attachmentPreview').classList.remove('show');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Modify the sendMessage function to handle attachments
    let isSendingMessage = false; // Add a flag to prevent duplicate submissions

    function sendMessage() {
      // Prevent duplicate submissions
      if (isSendingMessage) {
        console.log('Message already being sent, preventing duplicate submission');
        return;
      }

      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      const fileInput = document.getElementById('fileInput');
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      
      if (!activeChatId) {
        console.error('No active chat found');
        return;
      }
      
      // Don't send if both message and file are empty
      if (!message && !fileInput.files.length) {
        return;
      }

      // Set the flag to prevent duplicate submissions
      isSendingMessage = true;

      // Check if user is blocked before sending
      checkIfUserIsBlocked(activeChatId)
        .then(isBlocked => {
          if (isBlocked) {
            showToast('You cannot send messages to this user', 'error');
            isSendingMessage = false; // Reset flag
            return;
          }
          
          const formData = new FormData();
          formData.append('chat_id', activeChatId);
          formData.append('message', message);
          
          // Add attachment if present
          if (fileInput.files.length > 0) {
            formData.append('attachment', fileInput.files[0]);
          }
          
          // Send message with FormData
          fetch('/send_message/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            // Reset flag after response is received
            isSendingMessage = false;
            
            if (data.status === 'success') {
              // Remove the "No messages yet" prompt if it exists
              const noMessagesPrompt = document.getElementById('no-messages-prompt');
              if (noMessagesPrompt) {
                noMessagesPrompt.remove();
              }
              
              // Add the new message to the messages container
              const messagesContainer = document.querySelector('.messages-container');
              const messageDiv = document.createElement('div');
              messageDiv.className = 'message message-sent';
              messageDiv.dataset.messageId = data.message_id;
              messageDiv.dataset.senderId = "{{ request.user.id }}";
              messageDiv.setAttribute('oncontextmenu', 'showContextMenu(event, this)');
              
              
              // Create profile picture element
              const profilePicture = `
                <div class="message-pfp">
                  {% if request.user.profile_picture %}
                    <img src="{{ request.user.profile_picture.url }}" alt="Profile Picture">
                  {% else %}
                    <div class="pfp-initials">
                      {{ request.user.first_name|slice:":1" }}{{ request.user.last_name|slice:":1" }}
                    </div>
                  {% endif %}
                </div>
              `;
              
              // Create message content
              let messageContent = `
                <div class="message-content">
                  ${message}
              `;
              
              // Add attachment if present
              if (data.has_attachment) {
                if (data.attachment_type === 'image') {
                  messageContent += `
                    <div class="message-attachment">
                      <img src="${data.attachment_url}" alt="${data.attachment_name}" class="attachment-image">
                    </div>
                  `;
                } else {
                  messageContent += `
                    <div class="message-attachment">
                      <div class="file-icon">
                        ${getFileIcon(data.attachment_type)}
                      </div>
                      <div class="file-info">
                        <div class="file-name">${data.attachment_name}</div>
                        <a href="${data.attachment_url}" target="_blank" class="file-link">Download</a>
                      </div>
                    </div>
                  `;
                }
              }
              
              // Add message time with read receipt
              messageContent += `
                  <div class="message-time">
                    ${data.sent_at}
                    <div class="message-read-status" data-message-id="${data.message_id}">
                      <span class="read-receipt" id="read-receipt-${data.message_id}">
                        <span class="read-receipt-icon">&#10003;</span>
                      </span>
                    </div>
                  </div>
              `;
              
              messageDiv.innerHTML = profilePicture + messageContent;
              messagesContainer.appendChild(messageDiv);
              
              // Set up image attachment click listeners for the new message
              if (data.has_attachment && data.attachment_type === 'image') {
                const newImage = messageDiv.querySelector('.message-attachment img');
                if (newImage) {
                  newImage.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openImageViewer(this.src);
                  });
                }
              }
              
              // Update chat preview
              const activeChatItem = document.querySelector('.chat-item.active');
              if (activeChatItem) {
                const previewElement = activeChatItem.querySelector('.chat-item-preview');
                if (previewElement) {
                  if (message) {
                    previewElement.textContent = message;
                  } else if (data.has_attachment) {
                    previewElement.textContent = `Sent ${data.attachment_name}`;
                  }
                }
                
                const timeElement = activeChatItem.querySelector('.chat-item-time');
                if (timeElement) {
                  timeElement.textContent = data.sent_at;
                }
              }
              
              // Clear the input and attachment
              messageInput.value = '';
              removeAttachment();
              
              // Scroll to the bottom
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
              showToast(data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Error sending message:', error);
            showToast('Error sending message', 'error');
            isSendingMessage = false; // Reset flag on error
          });
        });
    }

    // Helper function to get file icon based on type
    function getFileIcon(type) {
      switch(type) {
        case 'pdf':
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 18C12 17.4 11.6 17 11 17C10.4 17 10 17.4 10 18C10 18.6 10.4 19 11 19C11.6 19 12 18.6 12 18Z" fill="white"/>
            <path d="M12 13C12 12.4 11.6 12 11 12C10.4 12 10 12.4 10 13V16C10 16.6 10.4 17 11 17C11.6 17 12 16.6 12 16V13Z" fill="white"/>
          </svg>`;
        case 'doc':
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 13H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 17H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 9H9H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        default:
          return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
      }
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function handleAttachment(event) {
      const file = event.target.files[0];
      const messageInput = document.getElementById('messageInput');
      
      if (file) {
        // Update the placeholder text to show the selected file
        messageInput.placeholder = `Sending: ${file.name}`;
        
        // Add a small filename display near the input
        const fileNameDisplay = document.createElement('div');
        fileNameDisplay.id = 'fileNameDisplay';
        fileNameDisplay.className = 'file-name-display';
        fileNameDisplay.innerHTML = `
          <span class="file-name">${file.name}</span>
          <button class="remove-file" onclick="removeAttachment()"></button>
        `;
        
        // Remove any existing file name display
        const existingDisplay = document.getElementById('fileNameDisplay');
        if (existingDisplay) {
          existingDisplay.remove();
        }
        
        // Add the file name display to the message input container
        const messageInputContainer = document.querySelector('.input-container');
        messageInputContainer.insertBefore(fileNameDisplay, messageInput);
        
        // Adjust the input padding to make room for the file display
        messageInput.style.paddingRight = '80px';
      }
    }

    function removeAttachment() {
      const fileInput = document.getElementById('fileInput');
      const messageInput = document.getElementById('messageInput');
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      
      fileInput.value = '';
      messageInput.placeholder = 'Type a message...';
      messageInput.style.paddingRight = '';
      
      if (fileNameDisplay) {
        fileNameDisplay.remove();
      }
    }

    // Add this new initialization function
    function initializeChatInterface() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      const inputArea = document.querySelector('.input-area');
      const messagesContainer = document.querySelector('.messages-container');
      
      if (activeChatId) {
        // Show input area if there's an active chat - use flex instead of block
        if (inputArea) {
          inputArea.style.display = 'flex';
          console.log('Setting input area display to flex for active chat', activeChatId);
        }
        
        // Ensure messages are visible
        if (messagesContainer) {
          messagesContainer.style.display = 'flex';
          scrollToBottom();
        }
      } else {
        console.log('No active chat found, input area will be hidden');
      }
    }

    // Update the DOMContentLoaded event listener
    document.addEventListener("DOMContentLoaded", function() {
      initializeChatInterface();
      
      // Add a forced refresh of the input area visibility after a slight delay
      setTimeout(() => {
        const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
        const inputArea = document.querySelector('.input-area');
        
        if (activeChatId && inputArea) {
          console.log('Forced refresh of input area display');
          inputArea.style.display = 'flex';
        }
      }, 300);
      
      // Set up other event listeners
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleAttachment);
      }
      
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.addEventListener('keydown', function(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
      }
    });

    // Also call initialization on window load as a fallback
    window.addEventListener('load', initializeChatInterface);

    // Add this to your existing JavaScript
    function openImageViewer(imageUrl) {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const fullscreenImage = document.getElementById('fullscreen-image');
      const downloadBtn = document.getElementById('download-image-btn');
      const navbar = document.querySelector('.navbar');
      
      fullscreenImage.src = imageUrl;
      
      // Set up download button
      if (downloadBtn) {
        downloadBtn.href = imageUrl;
        // Extract filename from URL to use as download name
        const fileName = imageUrl.split('/').pop();
        downloadBtn.setAttribute('download', fileName);
      }
      
      // Slide navbar up
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(-100%)';
      }
      
      // Show the viewer with transition
      viewer.style.display = 'block';
      // Trigger reflow to ensure the transition works
      viewer.offsetHeight;
      viewer.classList.add('visible');
      
      // Prevent scrolling on the body when modal is open
      document.body.style.overflow = 'hidden';
    }

    function closeImageViewer() {
      const viewer = document.getElementById('fullscreen-image-viewer');
      const navbar = document.querySelector('.navbar');
      
      // Slide navbar down
      if (navbar) {
        navbar.style.transition = 'transform 0.3s ease-out';
        navbar.style.transform = 'translateY(0)';
      }
      
      // Hide the viewer with transition
      viewer.classList.remove('visible');
      
      // Wait for the transition to complete before hiding
      setTimeout(() => {
        viewer.style.display = 'none';
      }, 300); // Match the transition duration (0.3s)
      
      // Re-enable scrolling on the body
      document.body.style.overflow = 'auto';
    }

    // Close the image viewer when clicking outside the image
    document.getElementById('fullscreen-image-viewer').addEventListener('click', function(event) {
      if (event.target === this) {
        closeImageViewer();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && document.getElementById('fullscreen-image-viewer').style.display === 'block') {
        closeImageViewer();
      }
    });

    // Add click event listeners to all image attachments
    document.addEventListener('DOMContentLoaded', function() {
      // Initial setup for existing images
      setupImageAttachmentListeners();
    });

    // Update this function to add click listeners to new image attachments
    // This should be called when new messages are added to the chat
    function appendMessage(data) {
      // Your existing appendMessage code
      
      // After appending the message, setup listeners for any new image attachments
      setupImageAttachmentListeners();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Set up chat interface
      initializeChatInterface();
      
      // Set up image attachment listeners for existing images
      setupImageAttachmentListeners();
      
      // Check for notifications
      checkNotifications();
      
      // Check initial read receipts
      checkReadReceipts();
      
      // Start read receipt polling
      startReadReceiptPolling();
      
      // Mark initial messages as read
      if (document.querySelector('.chat-item.active')) {
        markMessagesAsRead();
      }
      
      // Remove the reference to startNotificationPolling which is not defined and causing duplicate messages
      // if (typeof isUserAuthenticated !== 'undefined' && isUserAuthenticated) {
      //   startNotificationPolling();
      // }
    });

    // Start a polling mechanism to check read receipts
    function startReadReceiptPolling() {
      // Check read receipts more frequently for better responsiveness
      setInterval(checkReadReceipts, 2000); // Check every 2 seconds
    }

    function handleArchiveChat() {
      const activeChatId = document.querySelector('.chat-item.active')?.dataset.chatId;
      if (!activeChatId) {
        showToast('No active chat selected', 'error');
        return;
      }

      fetch('/archive_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: activeChatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove chat from the list
          const chatElement = document.querySelector(`[data-chat-id="${activeChatId}"]`);
          if (chatElement) {
            chatElement.remove();
          }
          
          // Clear the chat area
          document.querySelector('.chat-header').innerHTML = '';
          document.querySelector('.messages-container').innerHTML = 
            '<div class="start-message">Select a chat to start messaging or check archived chats</div>';
          document.querySelector('.input-area').style.display = 'none';
          
          // Close the user actions modal
          closeUserActionsModal();
          
          // Show success message
          showToast('Chat archived successfully');
        } else {
          showToast(data.message || 'Error archiving chat', 'error');
        }
      })
      .catch(error => {
        console.error('Error archiving chat:', error);
        showToast('Error archiving chat', 'error');
      });
    }

    function loadArchivedChats() {
      const container = document.getElementById('archivedChatsContainer');
      if (!container) return;
      
      // Show loading spinner
      container.innerHTML = '<div class="loading-spinner-container"><div class="loading-spinner"></div></div>';
      
      // Fetch archived chats
      fetch('/get_archived_chats/', {
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          if (data.chats && data.chats.length > 0) {
            // Create HTML for each archived chat
            const chatsHtml = data.chats.map(chat => {
              // Check if this is a group chat or individual chat
              if (chat.is_group) {
                // Group chat display
                return `
                  <div class="archived-chat-item" data-chat-id="${chat.id}" data-is-group="true">
                    <div class="chat-avatar group-avatar">
                      <div class="avatar-initials">${chat.name.charAt(0)}</div>
                    </div>
                    <div class="chat-info">
                      <div class="chat-name">${chat.name} <span class="group-badge">Group  ${chat.participants_count}</span></div>
                      <div class="chat-last-message">${chat.last_message}</div>
                    </div>
                    <div class="chat-actions">
                      <button class="unarchive-btn" onclick="unarchiveGroupChat(${chat.id})">Unarchive</button>
                    </div>
                  </div>
                `;
              } else {
                // Individual chat display
                return `
                  <div class="archived-chat-item" data-chat-id="${chat.id}" data-is-group="false">
                    <div class="chat-avatar">
                      ${chat.other_user.profile_picture 
                        ? `<img src="${chat.other_user.profile_picture}" alt="Profile">`
                        : `<div class="avatar-initials">${chat.other_user.first_name.charAt(0)}${chat.other_user.last_name.charAt(0)}</div>`
                      }
                    </div>
                    <div class="chat-info">
                      <div class="chat-name">${chat.name}</div>
                      <div class="chat-last-message">${chat.last_message}</div>
                    </div>
                    <div class="chat-actions">
                      <button class="unarchive-btn" onclick="unarchiveChat(${chat.id})">Unarchive</button>
                      <button class="open-btn" onclick="openArchivedChat(${chat.id})">Open</button>
                    </div>
                  </div>
                `;
              }
            }).join('');
            
            container.innerHTML = `
              <div class="archived-chats-list">
                ${chatsHtml}
              </div>
            `;
            
            // Add CSS for archived chat items
            const style = document.createElement('style');
            style.textContent = `
              .archived-chats-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
              }
              .archived-chat-item {
                display: flex;
                align-items: center;
                padding: 10px;
                border-radius: 8px;
                background: #2a2a2a;
                transition: background 0.2s;
              }
              .archived-chat-item:hover {
                background: #333;
              }
              .chat-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                overflow: hidden;
                margin-right: 10px;
                background: #333;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .group-avatar {
                background: #2196f3;
              }
              .chat-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
              }
              .avatar-initials {
                color: white;
                font-size: 16px;
                font-weight: bold;
              }
              .chat-info {
                flex: 1;
              }
              .chat-name {
                font-weight: bold;
                margin-bottom: 3px;
              }
              .group-badge {
                font-size: 11px;
                background: #2196f3;
                color: white;
                padding: 1px 6px;
                border-radius: 10px;
                margin-left: 5px;
                font-weight: normal;
              }
              .chat-last-message {
                font-size: 12px;
                color: #aaa;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 150px;
              }
              .chat-actions {
                display: flex;
                gap: 5px;
              }
              .chat-actions button {
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              }
              .unarchive-btn {
                background: #444;
                color: white;
              }
              .unarchive-btn:hover {
                background: #555;
              }
              .open-btn {
                background: #2196f3;
                color: white;
              }
              .open-btn:hover {
                background: #0d8bf2;
              }
            `;
            document.head.appendChild(style);
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No archived chats</div>';
          }
        } else {
          container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ff6b6b;">${data.message || 'Error loading archived chats'}</div>`;
        }
      })
      .catch(error => {
        console.error('Error loading archived chats:', error);
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b6b;">Error loading archived chats</div>';
      });
    }

    function openArchivedChatsModal() {
      const modal = document.getElementById('archivedChatsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        
        // Load archived chats
        loadArchivedChats();
      }
    }
    
    function closeArchivedChatsModal() {
      const modal = document.getElementById('archivedChatsModal');
      const backdrop = document.getElementById('modalBackdrop');
      
      if (modal && backdrop) {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      }
    }

    function unarchiveChat(chatId) {
      fetch('/unarchive_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ chat_id: chatId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Reload the archived chats list
          loadArchivedChats();
          
          // Reload the main chat list
          window.location.reload();
        } else {
          showToast(data.message || 'Error unarchiving chat', 'error');
        }
        })
        .catch(error => {
        console.error('Error unarchiving chat:', error);
        showToast('Error unarchiving chat', 'error');
      });
    }

    function unarchiveGroupChat(groupId) {
      fetch('/unarchive_group_chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ group_id: groupId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Reload the archived chats list
          loadArchivedChats();
          
          // Reload the main chat list
          window.location.reload();
        } else {
          showToast(data.message || 'Error unarchiving group chat', 'error');
        }
      })
      .catch(error => {
        console.error('Error unarchiving group chat:', error);
        showToast('Error unarchiving group chat', 'error');
      });
    }

    function openArchivedChat(chatId) {
      // Navigate to the chat detail page
      window.location.href = `/chats/${chatId}/`;
    }

    // Initialize archive button if it exists in the base template
    document.addEventListener('DOMContentLoaded', function() {
      const archiveButton = document.getElementById('archiveButton');
      if (archiveButton) {
        archiveButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openArchivedChatsModal();
        });
      }
      
      // Check if we should open the archived chats modal on page load
      if (sessionStorage.getItem('openArchives') === 'true') {
        // Clear the flag
        sessionStorage.removeItem('openArchives');
        // Open the modal after a short delay to ensure everything is loaded
        setTimeout(() => {
          openArchivedChatsModal();
        }, 500);
      }
    });

    function searchFriend() {
      const username = document.getElementById("friendUsername").value;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const searchResult = document.getElementById("search-result");
      
      if (!username.trim()) {
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">Please enter a username</div>';
        return;
      }
      
      console.log("Searching for user:", username);
      searchResult.innerHTML = '<div class="search-result-item">Searching...</div>';

      fetch("/search_user/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
        }),
      })
      .then(response => response.json())
      .then((data) => {
        console.log("Search response data:", data);
        if (data.status === "success") {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'search-result-item';
          resultDiv.textContent = `${data.first_name} ${data.last_name}`;
          resultDiv.addEventListener('click', function() {
            console.log('Search result clicked');
            startChat(data.username);
          });
          
          searchResult.innerHTML = '';
          searchResult.appendChild(resultDiv);
        } else {
          searchResult.innerHTML = `<div class="search-result-item" style="color: #ff6b6b;">${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error('Error in searchUser:', error);
        searchResult.innerHTML = '<div class="search-result-item" style="color: #ff6b6b;">An error occurred. Please try again.</div>';
      });
    }
    
    // Legacy function for backward compatibility
    function searchUser() {
      searchFriend();
    }

    // Add a function to scroll to the pinned message
    function scrollToPinnedMessage() {
      const messageId = document.getElementById('pinnedMessageContent').dataset.messageId;
      if (!messageId) return;
      
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageElement) return;
      
      // Scroll the message into view with smooth behavior
      messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Highlight the message briefly
      messageElement.style.transition = 'background-color 0.5s';
      messageElement.style.backgroundColor = 'rgba(52, 152, 219, 0.3)';
      
      setTimeout(() => {
        messageElement.style.backgroundColor = '';
        setTimeout(() => {
          messageElement.style.transition = '';
        }, 500);
      }, 1500);
    }
    
    // Function to restore pinned message on page load
    function restorePinnedMessage() {
      const pinnedMessageJSON = sessionStorage.getItem('pinnedMessage');
      if (!pinnedMessageJSON) return;
      
      try {
        const pinnedMessage = JSON.parse(pinnedMessageJSON);
        const messageElement = document.querySelector(`.message[data-message-id="${pinnedMessage.messageId}"]`);
        
        // If the message exists in this chat, restore the pin
        if (messageElement) {
          const pinnedMessageContent = document.getElementById('pinnedMessageContent');
          const pinnedMessageContainer = document.getElementById('pinnedMessageContainer');
          
          pinnedMessageContent.textContent = pinnedMessage.content;
          pinnedMessageContent.dataset.messageId = pinnedMessage.messageId;
          pinnedMessageContainer.classList.add('active');
        }
      } catch (error) {
        console.error('Error restoring pinned message:', error);
        sessionStorage.removeItem('pinnedMessage');
      }
    }

    // Call the restore function when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      restorePinnedMessage();
      
      // Other existing initialization code...
    });

    function sendLocation() {
      if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'error');
        return;
      }

      // Show loading state
      const locationButton = document.querySelector('.location-button');
      const originalIcon = locationButton.innerHTML;
      locationButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      locationButton.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          
          // Create OpenStreetMap link (doesn't require API key)
          const mapsUrl = `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}&zoom=15`;
          
          // Create static map URL using OpenStreetMap (doesn't require API key)
          const staticMapUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${latitude},${longitude}&zoom=15&size=300x200&markers=${latitude},${longitude}`;
          
          // Create HTML for the location message with embedded map
          const locationHTML = `
            <div class="location-message">
              <div class="location-preview" onclick="window.open('${mapsUrl}', '_blank')">
                <img src="${staticMapUrl}" alt="Location Map">
                <div class="location-coordinates">
                  <i class="fa-solid fa-location-dot"></i>
                  ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
                </div>
              </div>
            </div>
          `;

          // Send the location message as HTML
          const messageInput = document.getElementById('messageInput');
          const originalMessage = messageInput.value;
          messageInput.value = locationHTML;
          sendMessage();
          messageInput.value = originalMessage;

          // Reset button state
          locationButton.innerHTML = originalIcon;
          locationButton.disabled = false;
        },
        (error) => {
          console.error('Error getting location:', error);
          showToast('Could not get your location. Please check your permissions.', 'error');
          
          // Reset button state
          locationButton.innerHTML = originalIcon;
          locationButton.disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // Handle chat search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('contactSearch');
      const searchButton = document.getElementById('searchButton');
      
      if (searchInput && searchButton) {
        // Function to perform the search
        function performSearch() {
          console.log("Performing search...");
          const searchQuery = searchInput.value.toLowerCase().trim();
          const chatItems = document.querySelectorAll('.chat-item');
          let matchCount = 0;
          
          // Clear debugging info
          console.log("Search query:", searchQuery);
          console.log("Total chat items:", chatItems.length);
          
          chatItems.forEach(function(chatItem) {
            const nameElement = chatItem.querySelector('.chat-item-name');
            if (!nameElement) return;
            
            const chatName = nameElement.textContent.toLowerCase().trim();
            console.log("Checking chat:", chatName);
            
            // Simple direct string comparison - more reliable
            if (searchQuery === '' || chatName.includes(searchQuery)) {
              chatItem.style.display = 'flex';
              matchCount++;
              console.log(`Match found: ${chatName}`);
            } else {
              chatItem.style.display = 'none';
            }
          });
          
          console.log(`Search complete. Found ${matchCount} matches.`);
          
          // Show/hide "no results" message
          let noResultsMsg = document.getElementById('noSearchResults');
          
          if (matchCount === 0 && searchQuery !== '') {
            if (!noResultsMsg) {
              noResultsMsg = document.createElement('div');
              noResultsMsg.id = 'noSearchResults';
              noResultsMsg.style.textAlign = 'center';
              noResultsMsg.style.color = '#666';
              noResultsMsg.style.padding = '20px';
              noResultsMsg.textContent = 'No matching contacts found';
              const chatList = document.querySelector('.chat-list');
              if (chatList) chatList.appendChild(noResultsMsg);
            } else {
              noResultsMsg.style.display = 'block';
            }
          } else if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
          }
          
          // If there's exactly one match and a search query, flash that item
          if (matchCount === 1 && searchQuery !== '') {
            const matchedItem = Array.from(chatItems).find(item => item.style.display === 'flex');
            if (matchedItem) {
              matchedItem.style.transition = 'background-color 0.3s';
              matchedItem.style.backgroundColor = '#3a5998';
              setTimeout(() => {
                matchedItem.style.backgroundColor = '';
                // If there's exactly one visible chat after search, open it
                if (searchQuery.length > 0) {
                  matchedItem.click();
                }
              }, 800);
            }
          }
          
          return matchCount;
        }
        
        // Set up event listeners
        searchButton.addEventListener('click', function(e) {
          e.preventDefault();
          performSearch();
        });
        
        // Direct onclick handler (more reliable than addEventListener in some browsers)
        searchButton.onclick = performSearch;
        
        // Handle form submission (pressing Enter)
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault(); // Prevent form submission
            performSearch();
          }
        });
        
        // Add clear button functionality
        const searchContainer = document.querySelector('.search-container');
        if (searchContainer) {
          // Add a clear button if it doesn't exist
          if (!document.getElementById('clearSearch')) {
            const clearBtn = document.createElement('i');
            clearBtn.className = 'fa-solid fa-times';
            clearBtn.id = 'clearSearch';
            clearBtn.style.position = 'absolute';
            clearBtn.style.right = '38px'; // Position to the left of the search button
            clearBtn.style.top = '50%';
            clearBtn.style.transform = 'translateY(-50%)';
            clearBtn.style.color = '#999';
            clearBtn.style.cursor = 'pointer';
            clearBtn.style.display = 'none';
            clearBtn.style.zIndex = '5';
            
            clearBtn.addEventListener('click', function() {
              searchInput.value = '';
              this.style.display = 'none';
              performSearch(); // Show all chats again
              searchInput.focus();
            });
            
            searchContainer.appendChild(clearBtn);
          }
        }
        
        searchInput.addEventListener('input', function() {
          const clearBtn = document.getElementById('clearSearch');
          if (clearBtn) {
            clearBtn.style.display = this.value ? 'block' : 'none';
          }
        });
      }
    });
  </script>

  <!-- Just before the closing </div> at the end of the file -->

  <script>
  // Define global search function that can be called directly
  function searchContacts() {
    console.log("Search function called directly");
    const searchInput = document.getElementById('contactSearch');
    const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
    // Log search query for debugging
    console.log("Search query:", searchQuery);
    
    // Get all chat items
    const chatItems = document.querySelectorAll('.chat-item');
    console.log("Total chat items:", chatItems.length);
    
    let matchCount = 0;
    
    // Loop through each chat item
    chatItems.forEach(function(chatItem) {
      const nameElement = chatItem.querySelector('.chat-item-name');
      if (!nameElement) return;
      
      const chatName = nameElement.textContent.toLowerCase().trim();
      console.log("Checking chat:", chatName);
      
      // Simple search - just check if the name contains the query
      if (searchQuery === '' || chatName.includes(searchQuery)) {
        chatItem.style.display = 'flex';
        matchCount++;
      } else {
        chatItem.style.display = 'none';
      }
    });
    
    console.log(`Search complete. Found ${matchCount} matches.`);
    
    // Show/hide "no results" message
    let noResultsMsg = document.getElementById('noSearchResults');
    if (matchCount === 0 && searchQuery !== '') {
      if (!noResultsMsg) {
        noResultsMsg = document.createElement('div');
        noResultsMsg.id = 'noSearchResults';
        noResultsMsg.style.textAlign = 'center';
        noResultsMsg.style.color = '#666';
        noResultsMsg.style.padding = '20px';
        noResultsMsg.textContent = 'No matching contacts found';
        const chatList = document.querySelector('.chat-list');
        if (chatList) chatList.appendChild(noResultsMsg);
      } else {
        noResultsMsg.style.display = 'block';
      }
    } else if (noResultsMsg) {
      noResultsMsg.style.display = 'none';
    }
    
    // If there's exactly one match, highlight it
    if (matchCount === 1 && searchQuery !== '') {
      const matchedItem = Array.from(chatItems).find(item => item.style.display === 'flex');
      if (matchedItem) {
        matchedItem.style.transition = 'background-color 0.3s';
        matchedItem.style.backgroundColor = '#3a5998';
        setTimeout(() => {
          matchedItem.style.backgroundColor = '';
        }, 800);
      }
    }
    
    return false; // Prevent form submission
  }

  // Set up the search button with direct onclick handler
  document.addEventListener('DOMContentLoaded', function() {
    const searchButton = document.getElementById('searchButton');
    if (searchButton) {
      searchButton.onclick = searchContacts;
    }
    
    const searchInput = document.getElementById('contactSearch');
    if (searchInput) {
      searchInput.onkeydown = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchContacts();
        }
      };
    }
  });
  </script>

</div>
{% endblock %}

